<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>愛染メディカルセンター - 統合診療支援システム</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&display=swap');

body {
font-family: 'Inter', sans-serif;
user-select: none;
-webkit-user-select: none;
-ms-user-select: none;
background-color: #f8fafc;
}

img { -webkit-user-drag: none; user-drag: none; pointer-events: none; }
input, textarea { user-select: text; -webkit-user-select: text; -ms-user-select: text; }

.screen { display: none; }
.screen.active { display: flex; }

.blur-locked { filter: blur(12px); opacity: 0.3; transition: filter 0.5s ease, opacity 0.5s ease; }
.blur-none { filter: blur(0); opacity: 1; }

.transition-all { transition: all 0.3s ease-in-out; }
.view-content-detail { display: none; }
.view-content-detail.active { display: block; }

.soap-line {
position: absolute;
left: 20px; top: 24px; bottom: 24px;
width: 2px; background-color: #f1f5f9; z-index: 0;
}

.login-bg { background: radial-gradient(circle at top right, #eff6ff, #ffffff); }

@keyframes pulse-red {
0%, 100% { color: #dc2626; opacity: 1; }
50% { color: #ef4444; opacity: 0.5; }
}
.critical-alert { animation: pulse-red 1s infinite; font-weight: 900; }

#toast {
position: fixed; top: 20px; right: 20px;
background: #1e293b; color: #60a5fa;
padding: 1rem 2rem; border-radius: 1rem;
box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1);
z-index: 100; display: none;
font-family: monospace; border-left: 4px solid #3b82f6;
animation: slideIn 0.3s ease-out;
}
@keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }

/* ECG Canvas Style */
#ecg-container {
background: #0a0f14;
border-radius: 1rem;
position: relative;
overflow: hidden;
border: 1px solid #1e293b;
height: 180px;
}
.ecg-grid {
position: absolute;
inset: 0;
background-image: 
    linear-gradient(to right, rgba(0, 255, 0, 0.05) 1px, transparent 1px),
    linear-gradient(to bottom, rgba(0, 255, 0, 0.05) 1px, transparent 1px);
background-size: 20px 20px;
}
</style>
</head>
<body class="h-screen flex flex-col overflow-hidden font-sans" oncontextmenu="return false;">

<div id="toast"><span id="toast-msg">SYSTEM NOTIFICATION</span></div>

<!-- SCREEN 1: LOGIN -->
<div id="screen-login" class="screen active login-bg h-screen w-screen flex-col items-center justify-center">
<div class="w-full max-w-md p-8 text-center">
<div class="inline-flex p-4 bg-blue-600 rounded-3xl text-white shadow-xl shadow-blue-200 mb-6">
<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-12 h-12"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
</div>
<p class="text-slate-400 text-xs font-bold tracking-widest mt-2 uppercase mb-10">愛染メディカルセンター 統合医療情報システム</p>

<div class="bg-white p-10 rounded-[2.5rem] shadow-2xl shadow-slate-200 border border-slate-100 text-left">
<div class="space-y-6">
<div>
<label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">職員ID (Employee ID)</label>
<div class="relative mt-1">
<span class="absolute left-5 top-1/2 -translate-y-1/2 text-slate-500 font-mono text-sm font-bold select-none">AMC-</span>
<input type="text" id="loginId" placeholder="0000" maxlength="4" class="w-full pl-14 pr-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:outline-none transition-all font-mono text-slate-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
</div>
</div>
<div>
<label class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">セキュリティトークン</label>
<input type="password" id="loginToken" placeholder="********" class="w-full mt-1 px-5 py-4 bg-slate-50 border border-slate-200 rounded-2xl text-sm focus:outline-none transition-all font-mono text-slate-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
</div>
<button onclick="handleLogin()" class="w-full py-5 bg-blue-600 hover:bg-blue-700 text-white rounded-2xl font-black text-xs uppercase tracking-[0.2em] shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1 active:scale-95 flex items-center justify-center gap-3">
端末アクセス <i data-lucide="chevron-right" class="w-4 h-4 text-white"></i>
</button>
</div>
</div>
<p class="mt-10 text-[10px] text-slate-400 font-medium uppercase tracking-widest italic">関係者以外閲覧禁止 (Authorized Personnel Only) - MDC-04 Active Node</p>
</div>
</div>

<!-- SCREEN 2: PATIENT LIST -->
<div id="screen-list" class="screen h-screen w-screen flex-col bg-slate-50">
<header class="bg-white border-b border-slate-200 p-6 flex flex-col md:flex-row justify-between items-center shadow-sm gap-4">
<div class="flex items-center gap-4">
<div class="bg-blue-600 p-2 rounded-xl text-white"><i data-lucide="activity" class="w-6 h-6"></i></div>
<div>
<h1 class="text-xl font-black text-slate-800 tracking-tight uppercase">統合診療ダッシュボード</h1>
<p class="text-[9px] text-slate-400 font-bold uppercase tracking-widest mt-1 font-mono tracking-tight">接続状態: セキュア接続中 (Secured)</p>
</div>
</div>
<div class="flex items-center gap-6">
<div class="relative">
<i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
<input type="text" id="mainSearch" placeholder="患者名、IDで検索..." class="bg-slate-100 border-none rounded-full py-2 pl-10 pr-4 text-xs w-full md:w-80 focus:ring-2 focus:ring-blue-500 transition-all">
</div>
<button onclick="navigateTo('screen-login')" class="text-slate-400 hover:text-red-500 transition-colors"><i data-lucide="log-out" class="w-5 h-5"></i></button>
</div>
</header>

<main class="flex-1 overflow-y-auto p-10">
<div class="max-w-6xl mx-auto">
<div class="flex justify-between items-end mb-8">
<div>
<h2 class="text-3xl font-black text-slate-800 tracking-tighter uppercase">患者一覧 </h2>
<p class="text-sm text-slate-400 font-medium italic">重点管理患者 / 入院患者リスト</p>
</div>
</div>

<div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200 border border-slate-100 overflow-hidden overflow-x-auto">
<table class="w-full text-left border-collapse">
<thead class="bg-slate-50 border-b border-slate-100 font-sans">
<tr>
<th class="px-8 py-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">ID / 状態</th>
<th class="px-8 py-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">患者氏名</th>
<th class="px-8 py-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">診療科</th>
<th class="px-8 py-5 text-[10px] font-black text-slate-400 uppercase tracking-widest">最終更新</th>
<th class="px-8 py-5 text-right"></th>
</tr>
</thead>
<tbody id="patientListBody" class="divide-y divide-slate-50"></tbody>
</table>
</div>
<div class="flex justify-center gap-4 mt-8">
<button onclick="setPage(1)" id="btnPage1" class="px-6 py-3 rounded-xl font-black transition-all bg-blue-600 text-white shadow-lg shadow-blue-200 text-xs uppercase tracking-widest">Page 1</button>
<button onclick="setPage(2)" id="btnPage2" class="px-6 py-3 rounded-xl font-black transition-all bg-white text-slate-400 hover:bg-slate-100 text-xs uppercase tracking-widest">Page 2</button>
</div>
</div>
</main>
</div>

<!-- SCREEN 3: PATIENT DETAIL -->
<div id="screen-detail" class="screen h-screen w-screen flex-col bg-slate-100">
<header class="bg-slate-800 text-white p-3 flex flex-col md:flex-row justify-between items-center shadow-lg z-20 gap-2">
<div class="flex items-center gap-4">
<button onclick="navigateTo('screen-list')" class="p-2 hover:bg-slate-700 rounded-lg transition-colors">
<i data-lucide="arrow-left" class="w-5 h-5 text-slate-400"></i>
</button>
<div class="bg-blue-600 p-2 rounded-lg text-white font-black"><i data-lucide="activity" class="w-6 h-6"></i></div>
<h1 class="text-xl font-bold tracking-tight text-white italic uppercase tracking-tighter">愛染メディカルセンター <span class="text-blue-400 text-sm font-normal not-italic tracking-normal px-2 bg-slate-900 rounded">v8.2 (保護中)</span></h1>
</div>
<div class="flex items-center gap-6">
<div class="relative">
<i data-lucide="search" class="absolute left-3 top-2.5 text-slate-400 w-4 h-4"></i>
<input type="text" id="detailSearch" placeholder="患者ID/氏名検索..." class="bg-slate-700 border border-slate-600 rounded-full py-2 pl-10 pr-4 text-sm w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white transition-all">
</div>
<div class="flex items-center gap-3">
<i data-lucide="log-out" class="text-slate-400 cursor-pointer hover:text-white w-5 h-5"></i>
</div>
</div>
</header>

<div class="flex flex-col md:flex-row flex-1 overflow-hidden">
<nav id="detailSidebar" class="w-full md:w-64 bg-slate-50 border-b md:border-b-0 md:border-r border-slate-200 p-4 space-y-2 overflow-x-auto md:overflow-y-auto flex md:block gap-2 md:gap-0 shrink-0">
<!-- JS Injected -->
</nav>

<main class="flex-1 overflow-y-auto p-6 space-y-6">
<section id="patientDetailBanner" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
<!-- JS Injected -->
</section>

<!-- REALTIME ECG MONITOR (MAIN WINDOW) -->
<div id="ecg-container" class="shadow-inner">
<div class="ecg-grid"></div>
<div class="absolute top-4 left-4 z-10 flex items-center gap-2">
<span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
<span class="text-[10px] font-black text-green-500 uppercase tracking-widest font-mono">Real-time Telemetry: Lead II</span>
</div>
<canvas id="ecgCanvas" class="relative z-10 w-full h-full"></canvas>
</div>

<div id="versionToggleArea" class="flex justify-end gap-3 items-center">
<!-- JS Injected -->
</div>

<div class="grid grid-cols-1 lg:grid-cols-12 gap-8 pb-12">
<div class="col-span-1 lg:col-span-8 space-y-6">
<!-- VIEW: Info -->
<div id="view-info" class="view-content-detail">
<div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-8">
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-10 pb-10 border-b border-slate-100">
<div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
<h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="ruler" class="w-3 h-3"></i> 【身体計測】</h4>
<div id="infoPhysical" class="space-y-2"></div>
</div>
<div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
<h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="coffee" class="w-3 h-3"></i> 【社会歴】</h4>
<div id="infoSocial" class="space-y-2"></div>
</div>
<div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
<h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="accessibility" class="w-3 h-3"></i> 【介護・生活】</h4>
<div id="infoCare" class="space-y-2"></div>
</div>
<div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
<h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><i data-lucide="flask-conical" class="w-3 h-3"></i> 【血液型・感染症】</h4>
<div id="infoBio" class="space-y-2"></div>
</div>
</div>

<div class="space-y-10">
<div><h3 class="text-sm font-black text-slate-800 uppercase tracking-widest border-b pb-3 mb-6 flex items-center gap-2"><i data-lucide="user-plus" class="text-blue-500 w-4 h-4"></i> 既往歴 / 背景情報</h3><div id="infoHistory" class="space-y-4 text-sm text-slate-700 leading-relaxed font-medium"></div></div>
<div><h3 class="text-sm font-black text-slate-800 uppercase tracking-widest border-b pb-3 mb-6 flex items-center gap-2"><i data-lucide="pill" class="text-blue-500 w-4 h-4"></i> 服用中の薬剤 (常用薬)</h3><div id="infoMeds" class="bg-slate-50 p-6 rounded-2xl border border-slate-100 text-sm text-slate-700 font-medium"></div></div>
<div><h3 class="text-sm font-black text-slate-800 uppercase tracking-widest border-b pb-3 mb-6 flex items-center gap-2"><i data-lucide="phone-call" class="text-blue-500 w-4 h-4"></i> 緊急連絡先</h3><div id="infoContacts" class="grid grid-cols-1 gap-4"></div></div>
</div>
</div>
</div>

<!-- VIEW: SOAP -->
<div id="view-soap" class="view-content-detail active">
<div id="soapContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 relative overflow-hidden min-h-[600px]">
<div class="p-4 border-b border-slate-100 bg-slate-50 z-10 relative flex justify-between items-center"><h3 class="font-black text-slate-800 uppercase tracking-[0.2em] text-xs">経過記録 (SOAP)</h3></div>
<div id="soapContent" class="p-8 bg-slate-50/50 min-h-[500px] overflow-y-auto text-content"></div>
<div class="p-4 bg-slate-50 border-t border-slate-100 text-[10px] text-slate-400 flex justify-between relative z-10 font-mono">
<span id="footerUpdateSOAP">同期: ---</span>
<span id="footerTagSOAP" class="font-black text-amber-600 uppercase tracking-widest tracking-tighter">---</span>
</div>
</div>
</div>

<!-- VIEW: Orders -->
<div id="view-orders" class="view-content-detail">
<div id="orderContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px] transition-all font-sans overflow-x-auto">
<div class="p-5 border-b border-slate-100 bg-slate-50 font-sans"><h3 class="font-black uppercase tracking-[0.2em] text-xs text-slate-800">指示簿 (Active Orders)</h3></div>
<div class="p-0 text-content" id="orderContent"></div>
</div>
</div>

<!-- VIEW: Nursing -->
<div id="view-nursing" class="view-content-detail">
<div id="nursingContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[500px] transition-all text-content font-sans">
<div class="p-5 border-b border-slate-100 bg-slate-50"><h3 class="font-black uppercase tracking-[0.2em] text-xs text-slate-800">看護記録 (Nursing Log)</h3></div>
<div id="nursingContent" class="p-8 space-y-10"></div>
</div>
</div>

<!-- VIEW: Vitals -->
<div id="view-vitals" class="view-content-detail">
<div id="vitalsContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden transition-all text-content font-sans overflow-x-auto">
<div class="p-5 border-b border-slate-100 bg-slate-50 font-sans"><h3 class="font-black uppercase tracking-[0.2em] text-xs text-slate-800">バイタルサイン (Vital Sign Log)</h3></div>
<table class="w-full text-sm text-left">
<thead class="bg-slate-50 text-[10px] text-slate-400 uppercase font-black border-b tracking-widest font-sans">
<tr><th class="px-8 py-5">測定日時</th><th class="px-6 py-5 text-center">血圧</th><th class="px-6 py-5 text-center">心拍数</th><th class="px-6 py-5 text-center font-sans">SpO2</th><th class="px-6 py-5 text-center">体温</th><th class="px-8 py-5 text-right font-sans">実施者</th></tr>
</thead>
<tbody id="vitalsHistoryTable" class="divide-y divide-slate-50 text-slate-700 font-medium"></tbody>
</table>
</div>
</div>

<!-- VIEW: Documents -->
<div id="view-documents" class="view-content-detail">
<div id="documentsContainer" class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden min-h-[400px] overflow-x-auto">
<div class="p-5 border-b border-slate-100 bg-slate-50"><h3 class="font-black uppercase tracking-[0.2em] text-xs text-slate-800">文書管理 (Documents)</h3></div>
<div id="documentsContent" class="text-content font-sans"></div>
</div>
</div>
</div>

<div class="col-span-1 lg:col-span-4 space-y-8">
<!-- NUMERICAL VITAL MONITOR (SUB WINDOW) -->
<div id="global-monitor-panel" class="bg-slate-900 rounded-2xl shadow-2xl p-6 border-t-4 border-green-500">
<div class="flex justify-between items-center mb-6">
<h4 class="text-[9px] font-black text-slate-500 uppercase tracking-widest">生体情報モニタ</h4>
<span id="monitorStatus" class="text-green-500 font-bold text-[9px] uppercase animate-pulse tracking-widest font-sans">● 安定</span>
</div>
<div class="space-y-4 font-mono" id="latest-vitals-card"></div>
</div>

<div id="auditLogArea" class="hidden bg-slate-900 text-slate-300 rounded-2xl shadow-2xl p-6 border border-slate-800 font-mono text-[11px] space-y-4 transition-all transform scale-95 origin-top opacity-0 shadow-blue-900/10">
<div class="flex items-center justify-between mb-2 border-b border-slate-800 pb-3 font-sans">
<h4 class="text-blue-400 font-black uppercase tracking-widest flex items-center gap-2 font-sans"><i data-lucide="shield-check" class="w-4 h-4 text-blue-500 font-sans"></i> 監査ログ (Forensic)</h4>
</div>
<div id="currentViewIndicator" class="text-[9px] text-slate-500 uppercase tracking-widest mb-1 font-black font-sans">接続ノード: STREAM</div>
<div class="space-y-3 overflow-y-auto max-h-96 pr-2 font-sans" id="logItems"></div>
</div>
</div>
</div>
</main>
</div>
</div>

<!-- Auth Modal -->
<div id="authModal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-md hidden items-center justify-center z-50 transition-opacity opacity-0 text-center p-6">
<div class="bg-red-50 border-4 border-red-600 p-12 rounded-[3rem] shadow-2xl shadow-red-900/50 max-w-sm w-full relative overflow-hidden font-sans">
<div class="absolute top-0 left-0 w-full h-1.5 bg-gradient-to-r from-red-600 via-amber-500 to-red-600"></div>
<div class="bg-white w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-8 border-4 border-red-100 shadow-inner font-sans">
<i data-lucide="lock" class="text-red-600 w-12 h-12"></i>
</div>
<h4 class="text-red-900 font-black mb-1 uppercase tracking-[0.3em] text-sm">System Override <span class="block text-[10px] mt-1">アクセス拒否</span></h4>
<p class="text-red-800/60 text-[10px] leading-relaxed mb-10 uppercase tracking-widest font-black font-sans">Access Requires Authorized Virgo_Code</p>
<div class="space-y-6 font-sans">
<input type="password" id="pwField" placeholder="AUTH_CODE" class="w-full bg-white border-2 border-red-200 rounded-2xl px-5 py-4 text-sm text-center tracking-[0.5em] text-red-900 placeholder-red-300 transition-all font-black uppercase font-sans focus:border-red-500 focus:ring-4 focus:ring-red-500/20 outline-none">
<p id="pwErrorMsg" class="text-red-600 text-[10px] font-black hidden uppercase">Authentication Denied. / アクセス拒否</p>
<div class="grid grid-cols-2 gap-4 pt-4 font-sans">
<button onclick="cancelAuth()" class="py-4 rounded-2xl bg-white text-red-400 text-[10px] font-black tracking-widest uppercase hover:bg-red-50 transition-all font-sans">Abort</button>
<button onclick="submitAuth()" class="py-4 rounded-2xl bg-red-600 text-white text-[10px] font-black tracking-widest uppercase hover:bg-red-700 shadow-lg shadow-red-500/30 transition-all font-sans">Authorize</button>
</div>
</div>
</div>
</div>

<!-- Footer -->
<footer class="bg-slate-800 text-slate-500 text-[9px] px-6 py-2.5 flex justify-between border-t border-slate-700 z-30 font-sans tracking-widest uppercase">
<div class="flex gap-8">
<span class="flex items-center gap-2"><i data-lucide="cpu" class="w-3 h-3 text-slate-600"></i> コア: TOKYO-MDC-04-A</span>
<span class="font-bold text-green-500 italic">ネットワーク: 保護中</span>
</div>
<div class="flex gap-8 font-black text-slate-500">
<span>&copy; 2026 Aizen Medical Center</span>
</div>
</footer>

<script>
// --- DATA DEFS ---
const auditLogData = {
soap: [ { time: "01/18 02:25", user: "ADMIN", action: "診療録(Ver.1) 論理削除：入力誤りによる訂正" }, { time: "01/18 02:30", user: "ADMIN", action: "診療録(Ver.2) 修正確定" } ],
orders: [ { time: "01/18 02:45", user: "ADMIN", action: "緊急指示履歴 秘匿処理" } ],
nursing: [ { time: "01/18 02:15", user: "鈴木", action: "警告ログ 抹消" } ],
vitals: [ { time: "01/18 02:10", user: "SYSTEM", action: "データの平滑化補正" } ],
documents: [ { time: "01/18 04:05", user: "ADMIN", action: "緊急処置記録 アクセス権限凍結" } ],
info: [ { time: "01/18 09:10", user: "医事課", action: "属性更新" } ]
};

const patientsDb = {
フリガナ: {
id: "A-0089-SC", name: "HO1の名前", en: "フリガナ", age: "年齢", gender: "性別", dept: "心臓血管外科 / 主任医長", type: "employee",
hasHistory: false, v1_enabled: true, status: 'normal',
address: "東京都港区海鳴町 1-1-1 ベイサイドタワー2001", tel: "090-XXXX-XXXX",
v1: {
nursingAssessment: {
    complaint: "（JCS 300 昏睡につき聴取不能）",
    need: "【救命】気道・呼吸・循環の維持、大量輸血プロトコルの遂行、家族への緊急連絡と代理意思決定支援。",
    hope: "---",
    family: "（連絡中・未到着）"
},
soap: { 
    s: "救命隊からの申し送り：歩行中、交差点にて信号無視の大型車両と正面衝突。数メートル吹き飛ばされ、路面に全身を強打。現着時JCS 300（昏睡）。自発呼吸微弱。現場にて気道確保実施。", 
    o: "【Primary Survey】\n気道：吐血あり、吸引実施。呼吸：浅速、SpO2 82% (10L mask)。循環：橈骨動脈触知せず。BP 58/32, HR 145 (Sinus Tachy)。皮膚冷感・湿潤。\n【Secondary Survey】\n頭部：右側頭部に挫滅創。瞳孔 4.0/4.0 対光反射消失。\n胸腹部：右胸郭動揺（Flail Chest）。FAST陽性（モリソン窩・脾周囲）。肝損傷Grade IIIb疑い。\n四肢：右大腿変形・開放骨折。", 
    a: "1. 多発外傷（重症頭部外傷・胸部外傷・肝損傷）\n2. 出血性ショック（Class IV）\n3. 切迫する心停止（CPA）\n生存確率（Ps）5%未満。極めて予後不良。", 
    p: "直ちに気管挿管・人工呼吸管理。大量輸血プロトコル（MTP）発動。緊急開胸および大動脈遮断（ACC）の準備。家族へ危篤連絡。蘇生限界時はDNARの方針を確認する。" 
},
vitals: [
    {time:"01:15", bp:"40/Unmeas", hr:"160 (VF)", spo2:"Meas.Err", bt:"35.2", mews:"3", trend:"↓", user:"SYSTEM"}, 
    {time:"01:00", bp:"48/28", hr:"155", spo2:"70", bt:"35.3", mews:"3", trend:"↓", user:"救命チーム"},
    {time:"00:30", bp:"52/30", hr:"150", spo2:"78", bt:"35.5", mews:"3", trend:"↓", user:"救命チーム"},
    {time:"00:10", bp:"60/35", hr:"148", spo2:"80", bt:"35.6", mews:"3", trend:"↓", user:"救命チーム"},
    {time:"23:55", bp:"58/32", hr:"145", spo2:"82", bt:"35.8", mews:"3", trend:"↓", user:"救命チーム"}
],
orders: [
    {id:"ORD-9001", time:"23:55", type:"Stat", content:"アドレナリン 1mg [静注] 3分ごと", status:"Active", user:"救命医"}, 
    {id:"ORD-9002", time:"23:58", type:"Stat", content:"大量輸血プロトコル (RCC 10U / FFP 10U / PC 10U) [急速輸血]", status:"Done", user:"輸血部"},
    {id:"ORD-9003", time:"00:10", type:"Stat", content:"トラネキサム酸 1000mg [静注]", status:"Done", user:"救命医"},
    {id:"ORD-9004", time:"00:30", type:"Stat", content:"緊急開胸術 (蘇生的開胸)", status:"Prep", user:"外傷外科"}
],
nursing: [
    {time:"23:50", shift:"深夜", focus:"受入", title:"搬送受入", content:"ホットラインより重症外傷受入要請。ショックバイタル。外傷チーム招集。ルート確保困難、骨髄路確保。", user:"RNリーダー"},
    {time:"00:15", shift:"深夜", focus:"実施", title:"蘇生処置", content:"挿管介助。大量輸血開始。加温急速輸液装置使用。患者の意識レベル改善なし。瞳孔散大続く。", user:"外来RN"},
    {time:"01:10", shift:"深夜", focus:"急変", title:"状態悪化", content:"モニター上VF出現。除細動実施×3。反応なし。胸骨圧迫継続。医師より家族へ状況説明実施。", user:"RNリーダー"}
],
docs: [
    {date:"2026/01/17", type:"緊急", title:"救命同意記録 (代諾なし)", status:"LOCKED"},
    {date:"2026/01/17", type:"輸血", title:"生物由来製品使用同意書（緊急）", status:"LOCKED"},
    {date:"2026/01/17", type:"手術", title:"緊急手術・麻酔同意書", status:"LOCKED"}
],
footer: {date:"2026/01/17 23:55", tag:"※ 削除済みフラグあり"}
},
v2: {
nursingAssessment: {
    complaint: "「右の肘と膝が少し痛むくらいです。大げさにしてすみません」",
    need: "創部の感染徴候の観察、疼痛コントロール、早期退院に向けた調整。",
    hope: "仕事があるので早く退院したい。",
    family: "特になし。"
},
soap: { 
    s: "本人：「横断歩道で足がもつれて転倒した。車が近くを通ったが接触はしていない。右肘と膝を打って痛い」\n意識消失なし。頭痛・嘔気なし。", 
    o: "意識清明 (JCS 0, GCS 15)。バイタルサイン安定。BP 118/76, HR 72, SpO2 98% (RA)。\n頭部・胸腹部CT：骨折や頭蓋内出血などの外傷性変化なし。\n右肘・右膝：表皮剥離および軽度の打撲痕あり。腫脹軽度。可動域制限なし。", 
    a: "1. 右肘・右膝打撲\n2. 多発擦過傷\n神経学的異常なく、画像所見も陰性。軽症。", 
    p: "創部洗浄・処置（軟膏塗布）。念のため一晩経過観察入院とするが、明朝の回診で問題なければ退院可。疼痛時ロキソニン内服。" 
},
vitals: [
    {time:"07:00", bp:"120/78", hr:"70", spo2: "99", bt: "36.6", mews:"0", trend:"→", user: "病棟RN"},
    {time:"05:00", bp:"116/72", hr:"68", spo2: "98", bt: "36.4", mews:"0", trend:"→", user: "夜勤RN"},
    {time:"03:00", bp:"118/76", hr:"72", spo2: "98", bt: "36.5", mews:"0", trend:"→", user: "田中 RN"}, 
    {time:"01:15", bp:"115/74", hr:"74", spo2: "98", bt: "36.5", mews:"0", trend:"→", user: "SYSTEM"}
],
orders: [
    {id:"ORD-1001", time:"01:30", type:"Stat", content:"全身CT (外傷プロトコル)", status:"Done", user:"救急医"},
    {id:"ORD-1002", time:"02:00", type:"Routine", content:"創部洗浄・処置", status:"Done", user:"救急医"},
    {id:"ORD-1003", time:"09:15", type:"PRN", content:"ロキソプロフェン 60mg [内服] 疼痛時", status:"Active", user:"形成外科"}
],
nursing: [
    {time:"01:30", shift:"深夜", focus:"受入", title:"入院受入", content: "交通事故（自損転倒）としてERより入院。歩行可能。バイタル安定。本人「大げさにしたくない」と恐縮している。", user: "病棟RN"},
    {time:"08:30", shift:"日勤", focus:"報告", title:"日勤送り", content: "夜間帯安定。創部痛なし。朝食全量摂取。睡眠良好。退院待ち。", user: "高橋 RN"}
],
docs: [
    {date:"2026/01/18", type:"一般", title: "入院誓約書・身元保証書", status: "受領済"},
    {date:"2026/01/18", type:"一般", title: "退院計画書", status: "作成中"}
],
footer: {date:"2026/01/18 02:30", tag:"退院済"}
}
},
asuka_kagami: {
id: "K-3341-DA", name: "加賀美 明日香", en: "Kagami Asuka", age: "26", gender: "女性", dept: "形成外科 (心外併診)", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "A Rh(+)", height: "155", weight: "54", bmi: "22.5", occupation: "会社員 (産休中)", smoking: "なし", alcohol: "なし", adl: "ベッド上安静", diet: "常食 (鉄分強化)", allergy: "None", infection: "(-)",
address: "東京都世田谷区美空野 3-12-5 メゾン・ド・エトワール 201", tel: "090-XXXX-XXXX",
patientInfo: {
history: "現在妊娠9か月（33週5日）。これまでの経過は順調。当院にて妊婦健診を継続しており、前回（33週0日）の検診でも胎児の成長・胎動ともに良好と診断されていた。既往歴として、特記すべき重大な疾患や手術歴はない。",
meds: "・エレビット（葉酸サプリメント）服用中\n・フェロ・グラデュメット（鉄剤）服用中\n※妊娠中につき、NSAIDs（ロキソニン等）は禁忌。鎮痛が必要な場合はアセトアミノフェン（カロナール）限定とする。",
emergencyContacts: [
    { priority: 1, name: "加賀美 恭弥", relation: "夫", tel: "090-XXXX-XXXX", address: "患者本住所に同じ (同上)" },
    { priority: 2, name: "加賀美 佳子", relation: "義妹", tel: "080-XXXX-XXXX", address: "神奈川県横浜市青出区美波町 2-2-2" }
]
},
v2: {
nursingAssessment: {
    complaint: "「胸と腕が痛いです……お腹の赤ちゃんは本当に無事ですか？」",
    need: "【母体】外傷性ショックの回避、疼痛緩和、感染予防。\n【胎児】心拍数モニタリング、切迫早産徴候の早期発見。",
    hope: "とにかく子供を助けてほしい。夫の無事を確認したい。",
    family: "「妻と子供を最優先にしてください。私の怪我はどうでもいいです」（夫：恭弥）"
},
soap: { 
    s: "「青い雨災害（仮称）」に伴う交通事故により緊急搬送。夫（恭弥氏）が運転する車両の助手席に乗車中、対向車がハンドルミス（災害による視界不良・路面悪化と思われる）により正面衝突。衝突時、作動したエアバッグを貫通した鋭利な鉄片が身体を直撃。胸部および腕に強い衝撃と鋭い痛みを感じた。", 
    o: "トリアージ：赤。右前胸部および右前腕に深い裂傷、活動性出血あり。BP 92/50, HR 112。災害により院内は救急外来・ロビー含め飽和状態。胎児心拍 144bpm（Doppler確認）。FAST陰性。心外当直医により廊下にて緊急止血および局所麻酔下での創部縫合実施。処置後、経過観察のため入院。翌朝の精査にて、経胸壁エコー上で左心房内に約60mm大の可動性腫瘍（粘液腫疑い）を偶発的に確認。心臓外科へ引き継ぎ済み。", 
    a: "1. 全身多発裂傷（外科的処置済み）\n2. 妊娠33週・交通事故による切迫リスク（現在胎児安定）\n3. 左心房粘液腫（緊急摘出の検討を要する）", 
    p: "創部管理および感染予防。胎児モニター（NST）継続。心臓外科主任医長へコンサルト。腫瘍の嵌頓および突然死リスクについてIC実施予定。" 
},
vitals: [
    {time:"11:30", bp:"108/64", hr:"72", spo2:"99", bt:"36.4", mews:"0", trend:"→", user:"病棟RN"}, 
    {time:"09:00", bp:"106/62", hr:"76", spo2:"99", bt:"36.3", mews:"0", trend:"↗", user:"病棟RN"},
    {time:"07:00", bp:"104/60", hr:"80", spo2:"98", bt:"36.2", mews:"1", trend:"↗", user:"病棟RN"},
    {time:"05:30", bp:"102/60", hr:"88", spo2:"98", bt:"36.1", mews:"1", trend:"↗", user:"病棟RN"},
    {time:"04:15", bp:"92/50", hr:"112", spo2:"96", bt:"35.8", mews:"2", trend:"↓", user:"ER蘇生部"}
],
orders: [
    {id:"ORD-2001", time:"05:00", type:"Stat", content: "緊急止血・縫合術 (局所麻酔下)", status:"Done", user: "心外医官"},
    {id:"ORD-2002", time:"05:10", type:"Routine", content: "セファレキシン 250mg [内服] 1日3回 毎食後", status:"Active", user: "外科"},
    {id:"ORD-2003", time:"05:30", type:"Routine", content: "胎児心拍数モニタリング (NST)", status:"Done", user: "産婦人科"},
    {id:"ORD-2004", time:"09:00", type:"Routine", content: "経胸壁心エコー検査 (TTE)", status:"Done", user: "循環器"}
],
nursing: [
    {time:"04:15", shift:"深夜", focus:"受入", title:"緊急搬送", content: "青い雨災害による事故。病院ロビーまで負傷者溢れる中、優先搬送。本人、胎児を案じパニック状態。バイタル低値、加温と補液開始。", user: "鈴木 RN"},
    {time:"05:15", shift:"深夜", focus:"実施", title:"応急処置", content: "診察室不足のため廊下にて心外医師による縫合処置に同席。夫（恭弥氏）も隣のベッドで処置中であることを伝え、心理的サポート実施。胎児心拍良好。", user: "鈴木 RN"},
    {time:"10:30", shift:"日勤", focus:"報告", title:"医師報告", content: "エコーにて心臓内腫瘍発見。本人には「精密検査が必要」と説明。産婦人科と連携し、安静度をベッド上安静へ変更。", user: "高橋 RN"}
],
docs: [
    {date:"2026/01/18", type:"緊急", title:"災害時救急トリアージタグ（赤）", status:"記録済"},
    {date:"2026/01/18", type:"手術", title:"緊急創部処置・縫合同意書", status:"署名済"},
    {date:"2026/01/18", type:"一般", title:"入院誓約書（代諾：夫）", status:"受領済"}
],
footer: {date:"2026/01/18 11:30", tag:"災害搬送・心外併診"}
},
cardiac: {
patientInfo: {
    history: "妊娠33週。交通事故による多発外傷（処置済）。精査により左房粘液腫（65mm大）が判明。腫瘍嵌頓による突然死のリスクが高く、準緊急手術の方針。",
    meds: "・ヘパリンナトリウム（持続点滴）\n・リトドリン塩酸塩（子宮収縮抑制）\n・フェロ・グラデュメット（鉄剤）\n※血栓予防および切迫早産管理中。"
},
nursingAssessment: {
    complaint: "「胸の奥が詰まるようで苦しい。息がしにくい……」",
    need: "【厳重管理】腫瘍嵌頓による突然死（Sudden Death）の予防、絶対安静の保持、急変時即応体制の確立。",
    hope: "「私の命はどうなってもいい。この子（胎児）だけは絶対に助けてください」",
    family: "「母子ともに助けてほしい。しかし、もしどちらかしか選べないなら……妻の意思を尊重します」（夫）"
},
soap: [
    {
        date: "2026/01/18 16:30", dept: "心臓血管外科", author: "主任医長",
        s: "心臓血管外科診察：「時々、胸の奥が詰まるような苦しさがある。息がしにくい」\n本人・夫へのIC時：「お腹の子は助かるんですか。私のことはいいので、子供だけは絶対に助けてください」と涙ながらに訴え。",
        o: "【経食道心エコー(TEE)】\n左心房内に 65×50mm 大の巨大な可動性腫瘍（粘液腫様）を認める。腫瘍は有茎性で可動性が極めて高く、拡張期に僧帽弁口へ脱出し、左室流入血流を著しく阻害している（嵌頓寸前）。\n【全身状態】\n妊娠33週。循環動態は辛うじて保たれているが、体位変換等で容易に閉塞症状が出現する危険な状態。",
        a: "1. 巨大左房粘液腫 (Giant Left Atrial Myxoma)\n   - 腫瘍塞栓および弁口閉塞による突然死（Sudden Death）のリスクが切迫している。\n2. 妊娠33週\n   - 体外循環（人工心肺）使用に伴う胎児死亡・早産リスクが高い（30-50%）。\n\n# 緊急手術適応 (Urgent)\n極めて致死性が高く、2週間以内の待機は不可能。母体救命のためには準緊急での摘出術が絶対適応。",
        p: "1. 手術方針：人工心肺下 左房腫瘍摘出術（＋緊急帝王切開スタンバイ）。\n2. 体制：心臓外科（主任医長・部長クラス）、産婦人科、麻酔科、新生児科による合同チーム（Heart Team）を結成。\n3. 家族IC：母体救命を最優先とするが、可能な限り胎児温存を目指す方針を説明。術中の胎児心拍低下時は帝王切開への移行も考慮する。"
    },
    {
        date: "2026/01/18 15:30", dept: "産婦人科", author: "高田 玲子 (医長)",
        s: "心外術前コンサルト。胎児心拍良好。",
        o: "NST: Reactive. 推定体重2100g。現時点で胎児機能不全(NRFS)の所見なし。",
        a: "妊娠33週。母体救命優先だが、可能な限り胎児温存。",
        p: "術中帝王切開スタンバイ。NICUベッド確保。"
    }
],
vitals: [
    {time:"16:00", bp:"104/62", hr:"92", spo2:"96", bt:"36.7", mews:"1", trend:"→", user:"心外RN"},
    {time:"15:00", bp:"106/64", hr:"90", spo2:"97", bt:"36.7", mews:"1", trend:"→", user:"心外RN"},
    {time:"14:30", bp:"110/68", hr:"88", spo2:"97", bt:"36.6", mews:"0", trend:"→", user:"心外RN"},
    {time:"13:45", bp:"108/66", hr:"86", spo2:"98", bt:"36.5", mews:"0", trend:"→", user:"病棟RN"},
    {time:"13:00", bp:"108/64", hr:"84", spo2:"98", bt:"36.5", mews:"0", trend:"→", user:"病棟RN"}
],
orders: [
    {id:"ORD-3001", time:"14:00", type:"Routine", content: "ヘパリンナトリウム 24,000単位 [持続点滴] 1,000単位/時", status:"Active", user: "心外主任"},
    {id:"ORD-3002", time:"14:30", type:"Stat", content: "交差適合試験 (RCC 4単位)", status:"Done", user: "心外医"},
    {id:"ORD-3003", time:"15:00", type:"Routine", content: "絶飲食 (手術出しまで)", status:"Active", user: "心外医"},
    {id:"ORD-3004", time:"16:00", type:"Stat", content: "手術予約：左房粘液腫摘出術 (ハートチーム)", status:"Booked", user: "事務局長"}
],
nursing: [
    {time:"13:30", shift:"日勤", focus:"受入", title:"転科受入", content: "形成外科より転科。モニター装着。絶対安静（トイレ歩行不可）。夫付き添い。", user: "心外RN"},
    {time:"15:30", shift:"日勤", focus:"IC同席", title:"合同IC同席", content: "心臓外科部長、産婦人科医より病状説明。腫瘍による突然死のリスクと、手術による胎児への影響について説明。非常に厳しい内容に夫は顔面蒼白。本人は気丈に振る舞うが、時折腹部をさすり涙ぐむ様子あり。精神的サポート継続。", user: "心外RN"},
    {time:"16:30", shift:"準夜", focus:"実施", title:"術前訪問", content: "手術室看護師訪問。不安の傾聴。帝王切開の可能性についてもオリエンテーション実施。", user: "OP-RN"}
],
docs: [
    {date:"2026/01/18", type:"手術", title:"体外循環下心臓手術同意書（高リスク）", status:"署名済"},
    {date:"2026/01/18", type:"手術", title:"麻酔および輸血同意書", status:"署名済"},
    {date:"2026/01/18", type:"一般", title:"胎児リスクに関する説明同意書", status:"署名済"}
],
footer: {date:"2026/01/18 16:30", tag:"心外 術前評価・緊急性高"}
},
post_op: {
weight: "49", bmi: "20.4",
patientInfo: {
    history: "左房粘液腫摘出術および帝王切開術後（術後1日目）。母児ともにICU管理中。術後経過は順調。循環動態安定。",
    meds: "・アセトアミノフェン（疼痛時）\n・セファゾリンNa（感染予防）\n・オキシトシン（子宮収縮促進）\n・ミルリノン（循環補助・離脱中）"
},
nursingAssessment: {
    complaint: "「傷が痛みます。喉が渇いた……赤ちゃん（來花）に会いたい」",
    need: "術後疼痛管理、呼吸循環の安定化、早期離床、母子対面（ボンディング）の支援。",
    hope: "早く回復してNICUの娘に会いに行きたい。",
    family: "「奇跡的だ。本当に感謝しています」（夫）"
},
soap: [
    {
        date: "2026/01/23 09:00", dept: "心臓血管外科", author: "主任医長",
        s: "術後1日目回診。\n本人：「胸とお腹の傷が痛みますが、息苦しさは消えました。……赤ちゃんは無事ですか？」\n夫：「無事だよ、二人とも生きてるよ明日香。良かった……ホントに。」",
        o: "【循環動態】\nBP 110/68, HR 85 (Sinus), SpO2 98% (O2 2L)。昇圧剤離脱完了。\n【呼吸】\n抜管済。呼吸音清。\n【産婦人科所見】\n子宮収縮良好（収縮剤投与中）。悪露：赤色、中等量。帝王切開創：滲出液なし、発赤なし。\n【児の状態】\n2150g, 女児。Apgar 8/9。NICUにて管理中だが呼吸循環安定。",
        a: "1. 左房粘液腫摘出術後（順調）\n2. 緊急帝王切開術後（妊娠33週）\n母児ともに経過良好。早産児ではあるが、児のバイタルは安定しており予後良好と判断される。",
        p: "本日より水分摂取開始。疼痛コントロール（アセトアミノフェン）。NICU面会は本人の移動が可能になり次第調整。搾乳指導予定。"
    },
    {
        date: "2026/01/23 10:00", dept: "ICU", author: "ICU看護師長",
        s: "「傷の痛みは痛み止めで落ち着いています。早く搾乳して、あの子（來花）に届けたいです」",
        o: "【神経系】\n意識清明 (GCS E4V5M6)。四肢麻痺なし。鎮痛コントロール良好 (NRS 3/10)。\n【呼吸・循環】\nSpO2 98% (カニューラ 2L)。呼吸苦なし。HR 80-90台で安定。不整脈なし。\n【腹部・創部】\n腹部軟。腸蠕動音聴取可。帝王切開創および胸骨正中切開創ともに異常なし。ドレーン排液：漿液性、減少傾向。\n【乳房】\n乳管開通確認。初乳分泌あり。",
        a: "術後1日目。循環動態安定。離床および経口摂取の開始基準を満たす。母乳育児への意欲が高く、精神的にも前向きな状態。",
        p: "1. 離床リハビリ開始（端座位〜車椅子）。\n2. 飲水テスト実施。\n3. 助産師と連携し搾乳ケア介入。\n4. 午後、NICU面会へ案内予定。"
    }
],
vitals: [
    {time:"08:00", bp:"112/70", hr:"82", spo2:"98", bt: "36.8", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"06:00", bp:"110/68", hr:"80", spo2:"99", bt: "36.9", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"04:00", bp:"108/65", hr:"78", spo2:"99", bt: "37.0", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"00:00", bp:"106/64", hr:"80", spo2:"98", bt: "37.1", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"22:00", bp:"108/66", hr:"82", spo2:"98", bt: "37.1", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"20:00", bp:"110/68", hr:"85", spo2:"98", bt: "37.2", mews:"0", trend:"→", user:"ICU-RN"}
],
orders: [
    {id:"ORD-4001", time:"09:00", type:"Routine", content: "胸腔ドレーン抜去", status:"Done", user: "心外医"},
    {id:"ORD-4002", time:"09:15", type:"Routine", content: "オキシトシン 5単位 [点滴] 子宮収縮促進", status:"Active", user: "産科医"},
    {id:"ORD-4003", time:"09:30", type:"PRN", content: "アセトアミノフェン 500mg [内服] 疼痛時", status:"Active", user: "ICU医"},
    {id:"ORD-4004", time:"10:00", type:"Routine", content: "NICU面会許可 (車椅子)", status:"Approved", user: "新生児科"}
],
nursing: [
    {time:"18:30", shift:"準夜", focus:"受入", title:"ICU収容", content: "OP室より帰室。心臓手術および帝王切開の同時手術終了。意識清明。開口一番に「來花（らいか）は？」と娘の名前を呼ぶ。NICUの画像を見せると安堵の涙。夫面会、手を握り励ましている。", user: "ICUリーダー"},
    {time:"22:00", shift:"準夜", focus:"観察", title:"夜間経過", content: "入眠中。胸部および腹部創痛に対し鎮痛剤使用。モニターアラームなし。", user: "ICU-RN"},
    {time:"08:30", shift:"日勤", focus:"報告", title:"申し送り", content: "バイタル安定。離床開始許可あり。NICUより児（來花ちゃん）の状態安定との連絡あり、本人へ伝達済。", user: "ICUリーダー"}
],
docs: [
    {date:"2026/01/22", type:"手術", title:"手術実施報告書（左房粘液腫摘出術）", status:"確定済"},
    {date:"2026/01/22", type:"手術", title:"手術実施報告書（帝王切開術）", status:"確定済"},
    {date:"2026/01/22", type:"公的", title:"出生証明書", status:"作成中"}
],
footer: {date:"2026/01/23 09:00", tag:"術後 ICU管理中"}
},
exitus: {
nursingAssessment: {
    complaint: "（反応なし）",
    need: "エンゼルケア、ご家族へのグリーフケア、退院（搬出）調整。",
    hope: "---",
    family: "（呆然自失・受容困難）"
},
soap: { 
    s: "(患者死亡につき聴取不能)", 
    o: "【術中経過】\n人工心肺確立後、左房切開。腫瘍は予想以上に脆弱であり、操作中に一部が崩壊。直ちに吸引を試みるも、微細な腫瘍片が左室から大動脈へ流出。\n大動脈遮断解除後、心拍再開せず（Refractory VF）。直除細動、抗不整脈薬投与を行うも反応なし。\n経食道エコーにて冠動脈（LMT）への塞栓疑い。PCPS補助下で冠動脈バイパスを試みるも、心筋の広範なダメージにより収縮力回復せず。\n17:30 胎児心拍低下（Bradycardia）。緊急帝王切開を検討するも、母体の凝固能破綻（DIC）および循環虚脱により、胎児救出も困難と判断（母体死亡に伴う胎児死亡）。\n17:42 全蘇生処置を中止。", 
    a: "1. 術中死 (Exitus in Tabula)\n2. 腫瘍塞栓による急性心筋梗塞・心原性ショック\n3. 胎児死亡 (Intrauterine Fetal Death)", 
    p: "死亡宣告。カテーテル類の抜去、エンゼルケア。ご家族への説明と精神的ケア（グリーフケア）。病理解剖は拒否される。" 
},
vitals: [
    {time:"17:42", bp:"0/0", hr:"0 (Flat)", spo2: "0", bt: "34.8", mews:"3", trend:"↓", user: "執刀医"},
    {time:"17:40", bp:"15/--", hr:"20 (Agonal)", spo2: "20", bt: "34.9", mews:"3", trend:"↓", user: "麻酔科医"},
    {time:"17:30", bp:"30/--", hr:"40 (VF)", spo2: "45", bt: "35.0", mews:"3", trend:"↓", user: "麻酔科医"},
    {time:"17:25", bp:"45/20", hr:"130 (VT)", spo2: "60", bt: "35.2", mews:"3", trend:"↓", user: "麻酔科医"},
    {time:"17:15", bp:"60/40", hr:"150 (VT)", spo2: "88", bt: "35.5", mews:"3", trend:"↓", user: "麻酔科医"},
    {time:"17:00", bp:"90/50", hr:"100", spo2: "98", bt: "36.0", mews:"2", trend:"↓", user: "麻酔科医"}
],
orders: [
    {id:"ORD-5001", time:"17:15", type:"Stat", content: "エピネフリン 1mg [静注] 3分ごと", status:"Done", user: "麻酔科医"},
    {id:"ORD-5002", time:"17:20", type:"Stat", content: "開胸心臓マッサージ", status:"Done", user: "執刀医"},
    {id:"ORD-5003", time:"17:42", type:"Stat", content: "死亡確認・宣告", status:"Done", user: "事務局長"}
],
nursing: [
    {time:"17:15", shift:"準夜", focus:"急変", title:"術中急変", content: "大動脈遮断解除後、VF出現。除細動無効。心拍再開せず。術野にて心マ開始。緊張走る。", user: "OP-RN"},
    {time:"17:30", shift:"準夜", focus:"異常", title:"胎児徐脈", content: "産科医により胎児心拍低下を確認。母体優先のため帝王切開困難との判断。", user: "OP-RN"},
    {time:"17:42", shift:"準夜", focus:"臨終", title:"臨終記録", content: "蘇生中止。執刀医により死亡宣告。モニター電源OFF。家族へ連絡。手術室入口にて夫が取り乱し荒げた声を聴取。", user: "OP-RN"}
],
docs: [
    {date:"2026/01/22", type:"公的", title:"死亡診断書", status:"作成済"},
    {date:"2026/01/22", type:"公的", title:"死産届", status:"作成済"},
],
footer: {date:"2026/01/22 18:00", tag: "死亡確定"}
}
},
kyoya_kagami: {
id: "K-3342-DK", name: "加賀美 恭弥", en: "Kagami Kyoya", age: "26", gender: "男性", dept: "形成外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
address: "東京都世田谷区美空野 3-12-5 メゾン・ド・エトワール 201", tel: "090-XXXX-XXXX",
patientInfo: { 
    history: "特記すべき既往歴なし。健康状態良好。", 
    meds: "常用なし。", 
    emergencyContacts: [
        { priority: 1, name: "加賀美 明日香", relation: "妻", tel: "090-XXXX-XXXX", address: "患者本住所に同じ (同上)" },
        { priority: 2, name: "加賀美 佳子", relation: "妹", tel: "080-XXXX-XXXX", address: "神奈川県横浜市青出区美波町 2-2-2" },
        { priority: 3, name: "加賀美 茂", relation: "父", tel: "03-XXXX-XXXX", address: "東京都大田区多摩川台 1-1-5" }
    ]
},
v2: {
nursingAssessment: {
    complaint: "「俺のことはいいです。妻（明日香）の様子はどうですか？」",
    need: "創部感染予防、精神的サポート（妻への不安軽減）、休息の確保。",
    hope: "妻のそばにいたい。妻と子供を助けてほしい。",
    family: "「兄（恭弥）を落ち着かせてほしい。無理をしている」（妹）"
},
soap: { 
    s: "「青い雨災害」に伴う交通事故により緊急搬送。運転席にて乗車中、正面衝突。助手席の妻（明日香氏）を庇おうとした際に右半身および顔面を強打。「妻の状態を優先してほしい」との強い要望あり。", 
    o: "意識清明。バイタル安定。BP 116/74, HR 68。右前腕に深い裂傷および側頭部擦過傷、活動性出血あり。ER飽和につき心外医師により隣接臨時処置エリアにて創部止血・縫合実施。全身CTにて頭部・胸腹部に有意な損傷・内臓出血なし。", 
    a: "1. 全身多発裂傷（処置済）\n2. 交通事故による軽度ショック状態（改善）", 
    p: "1日経過観察入院。創部感染および神経学的異常なきこと確認後、退院許可。妻の入院治療を優先するため、早期退院を希望。" 
},
vitals: [
    {time:"10:00", bp:"116/74", hr:"68", spo2:"98", bt:"36.6", mews:"0", trend:"→", user:"病棟RN"},
    {time:"08:00", bp:"118/76", hr:"70", spo2:"99", bt:"36.5", mews:"0", trend:"→", user:"病棟RN"},
    {time:"06:00", bp:"120/78", hr:"74", spo2:"98", bt:"36.4", mews:"0", trend:"→", user:"病棟RN"},
    {time:"04:15", bp:"122/80", hr:"94", spo2:"98", bt:"36.2", mews:"1", trend:"↓", user:"ER蘇生部"}
],
orders: [
    {id:"ORD-6001", time:"05:00", type:"Stat", content: "右前腕縫合術 (局所麻酔下)", status:"Done", user: "心外当直"},
    {id:"ORD-6002", time:"09:00", type:"Routine", content: "全身CT (スクリーニング)", status:"Done", user: "放射線科"}
],
nursing: [
    {time:"04:15", shift:"深夜", focus:"受入", title:"緊急搬送", content: "交通事故搬送。本人自身の負傷よりも助手席の妻（妊婦）の状態を極めて案じ、パニック様状態。救急隊に対し、自分は後回しでよいと繰り返し訴え。", user: "鈴木 RN"},
    {time:"05:15", shift:"深夜", focus:"実施", title:"同時処置", content: "心外医師の判断により、隣のベッドで明日香氏と並行して処置開始。妻の意識があることを確認し、徐々に落ち着きを取り戻す。右腕の裂傷は深いが神経損傷なし。", user: "鈴木 RN"},
    {time:"10:30", shift:"日勤", focus:"指導", title:"退院許可", content: "ADL自立。創部疼痛自制内。CT異常なし。明日香氏の入院継続と心疾患の疑いについて説明を受け、同意。一旦退院し、身の回りの準備を行う。", user: "病棟RN"}
],
docs: [
    {date:"2026/01/18", type:"一般", title:"入院計画書", status:"署名済"},
    {date:"2026/01/18", type:"一般", title:"退院許可証明書", status:"発行済"},
    {date:"2026/01/18", type:"一般", title:"退院計画書（受領）", status:"署名済"}
],
footer: {date:"2026/01/18 10:30", tag:"退院済"}
}
},
kokoro_akiyama: {
id: "A-8812-KC", name: "秋山 こころ", en: "Akiyama Kokoro", age: "13", gender: "女性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
height: "152", weight: "42", bmi: "18.2", occupation: "中学生", smoking: "なし", alcohol: "なし", adl: "自立 (院内散歩可)", diet: "常食 (偏食あり)", bloodType: "B Rh(-)", allergy: "卵", infection: "(-)",
address: "宮城県仙台市青葉区片平 2-1-1 (実家) / 東京都杉並区阿佐谷南 3-10-5 (兄宅)", tel: "090-XXXX-XXXX (兄)",
patientInfo: { 
    history: "【診断名】螺旋冠状動脈変性症 (SCTS)\n半年前、学校検診での心電図異常を契機に発覚。地方病院より紹介受診。冠状動脈の螺旋状変形と心筋内埋没を認める難治性疾患。\n3ヶ月前より手術目的で入院するも、執刀予定医の交通事故により延期。現在、待機中。\n既往：気管支喘息（小児期より）。", 
    meds: "・アドエア吸入（喘息用）\n・ミオコールスプレー（発作時頓用）", 
    emergencyContacts: [
        { priority: 1, name: "秋山 善治", relation: "兄", tel: "090-XXXX-XXXX", address: "東京都杉並区阿佐谷南 3-10-5" },
        { priority: 2, name: "秋山 幸代", relation: "母", tel: "022-XXXX-XXXX", address: "宮城県仙台市青葉区片平 2-1-1" }
    ]
},
v2: {
nursingAssessment: {
    complaint: "「手術、いつになるのかな。……制服、飾ってあるけど着れるようになるかな」",
    need: "【SCTS管理】突発的な胸痛・不整脈の監視。\n【精神的ケア】手術延期による不安、同室者不在（死亡退院）による孤独感への配慮。\n【栄養】偏食への対応。",
    hope: "手術を受けて元気になりたい。学校に行きたい。",
    family: "兄（善治氏）が頻繁に面会。キーパーソンは兄。"
},
    soap: [
        {
            date: "2026/01/18 10:00", dept: "心臓血管外科", author: "担当医",
            s: "「今日は胸の痛みはないです。中庭まで散歩してきました。給食のニンジンが苦手で……」\n院内学級については「今日は体がだるいので休みました」とのこと。",
            o: "【全身状態】\nバイタル安定。SpO2 98%。心音整。肺音清。\n【生活】\nADL自立。院内散歩を日課としている。食事摂取量ムラあり（偏食）。\n【環境】\n2人部屋だが、同室患児の転帰（1名退院、1名死亡）により現在個室状態。私服や制服を壁に飾っている。",
            a: "1. 螺旋冠状動脈変性症 (SCTS)\n   - 待機的入院3ヶ月目。症状は安定しているが、いつ急変してもおかしくない状態。\n   - 執刀医復帰済みだが、SCTS手術には大規模なチーム編成が必要であり、スケジュール調整難航中。\n2. 入院長期化に伴うストレス\n   - 院内学級への参加も不定期。モチベーション維持が課題。",
            p: "厳重な経過観察継続。発作時即応体制。栄養科と相談し食事形態の工夫。兄（善治氏）への現状報告。"
        },
        {
            date: "2025/12/20 14:00", dept: "心臓血管外科", author: "主任医長",
            s: "手術延期の説明。「……そっか。じゃあ、まだ手術できないんだ」と気丈に振る舞うが、表情は硬い。",
            o: "執刀予定医の交通事故受傷に伴い、手術スケジュールの白紙化を説明。本人、家族（兄）同席。\n兄は「その間に発作が起こったらどう対応するのか」と動揺隠せず。",
            a: "手術延期による精神的動揺（Mental Distress）。",
            p: "退院はさせず、そのまま待機入院継続。メンタルケア介入。"
        },
        {
            date: "2025/10/15 11:00", dept: "心臓血管外科", author: "担当医",
            s: "入院時診察。手術内容を伝えても無言が多く、不安感が見て取れる。",
            o: "SCTS手術目的での入院。紹介状確認。CAGにてLADおよびRCAに著明な螺旋状変形あり。",
            a: "螺旋冠状動脈変性症 (SCTS)。手術適応あり。",
            p: "術前検査開始。手術予定を調整。"
        }
    ],
vitals: [
    {time:"14:00", bp:"98/62", hr:"78", spo2:"98", bt:"36.6", mews:"0", trend:"→", user:"病棟RN"},
    {time:"10:00", bp:"100/64", hr:"80", spo2:"99", bt:"36.5", mews:"0", trend:"→", user:"病棟RN"},
        {time:"07:00", bp:"96/60", hr:"72", spo2:"99", bt:"36.4", mews:"0", trend:"→", user:"夜勤RN"},
        {time:"1/17 21:00", bp:"98/60", hr:"75", spo2:"99", bt:"36.7", mews:"0", trend:"→", user:"夜勤RN"},
        {time:"1/17 14:00", bp:"102/64", hr:"82", spo2:"98", bt:"36.8", mews:"0", trend:"→", user:"病棟RN"},
        {time:"12/20 15:00", bp:"110/70", hr:"95", spo2:"99", bt:"37.0", mews:"0", trend:"↗", user:"外来RN"},
        {time:"10/15 10:00", bp:"100/60", hr:"88", spo2:"99", bt:"36.6", mews:"0", trend:"→", user:"外来RN"}
],
orders: [
    {id:"ORD-7001", time:"09:00", type:"Routine", content: "心臓食 (卵除去・嫌気配慮)", status:"Active", user: "栄養科"},
    {id:"ORD-7002", time:"09:00", type:"Routine", content: "院内フリー (散歩可・要連絡)", status:"Active", user: "心外医"},
    {id:"ORD-7003", time:"10:00", type:"PRN", content: "ミオコールスプレー [胸痛時]", status:"Active", user: "心外医"}
],
nursing: [
    {time:"10:00", shift:"日勤", focus:"観察", title:"日課散歩", content: "「体力を落としたくない」と病棟内〜中庭を散歩。表情は明るいが、時折胸を押さえる仕草あり（本人曰く「癖みたいなもの」）。", user: "病棟RN"},
    {time:"13:00", shift:"日勤", focus:"面会", title:"家族面会", content: "兄（善治氏）来院。洗濯物の交換と差し入れ。兄の前では笑顔が多い。「お兄ちゃん、仕事忙しいのにごめんね」と気遣う様子。", user: "病棟RN"},
        {time:"14:30", shift:"日勤", focus:"環境", title:"訪室", content: "同室者が亡くなってから「夜が少し怖い」と漏らす。カーテンを開けて明るくするよう配慮。", user: "病棟RN"},
        {time:"12/20", shift:"日勤", focus:"心理", title:"手術延期", content: "医師からの説明後、ベッドで静かに泣いているのを確認。「大丈夫」と言うが、ショックは大きい様子。傾聴。", user: "病棟RN"},
        {time:"10/15", shift:"日勤", focus:"入院", title:"入院オリエンテーション", content: "地方より転院。緊張した様子だが、受け答えはしっかりしている。持参した制服を「お守り」として飾りたいと希望あり、許可。", user: "病棟RN"}
],
docs: [
    {date:"2025/10/15", type:"一般", title:"入院誓約書", status:"受領済"},
    {date:"2025/10/15", type:"公的", title:"特定医療費（指定難病）受給者証", status:"確認済"},
    {date:"2025/11/01", type:"手術", title:"手術同意書（延期中）", status:"保留"}
],
footer: {date:"2026/01/18 14:00", tag:"術前待機・長期"}
},
pre_op: {
nursingAssessment: {
    complaint: "（意識レベル低下 JCS 200）",
    need: "【緊急救命】循環動態の維持、致死性不整脈の管理、緊急手術出し。",
    hope: "---",
    family: "（兄：善治氏 死亡確認済み）"
},
soap: {
    s: "救急搬送。病院中庭にて、兄（善治氏）が転落した瞬間を至近距離で目撃。直後に悲鳴を上げ、胸部を鷲掴みにしてその場に倒れ込んだ。",
    o: "【来院時所見】\nJCS 200 (半昏睡)。顔面蒼白、冷汗著明、四肢冷感。\nBP 68/42, HR 135 (VT run), SpO2 85% (O2 10L)。\n心電図：広範なST上昇、R on T性PVC頻発。\n心エコー：冠動脈の攣縮およびSCTSの構造的閉塞による広範囲心筋虚血。EF 25%。",
    a: "1. 螺旋冠状動脈変性症 (SCTS) 急性増悪\n2. 心原性ショック\n3. 急性ストレス反応\n肉親の凄惨な死を目撃した精神的ショックがトリガーとなり、交感神経ストームが発生。SCTSの病態を急激に悪化させ、心停止寸前の状態。",
    p: "緊急挿管・鎮静。PCPS（経皮的心肺補助）確立。直ちに緊急手術（SCTS根治術）へ移行。一刻の猶予もない。"
},
vitals: [
    {time:"00:15", bp:"68/42", hr:"135 (VT)", spo2:"85", bt:"35.0", mews:"3", trend:"↓", user:"救急隊"},
    {time:"00:05", bp:"75/48", hr:"120", spo2:"90", bt:"35.5", mews:"3", trend:"↓", user:"ER-RN"}
],
orders: [
    {id:"ORD-7901", time:"00:15", type:"Stat", content:"緊急気管挿管・人工呼吸管理", status:"Done", user:"救急医"},
    {id:"ORD-7902", time:"00:20", type:"Stat", content:"PCPS (VA-ECMO) 確立", status:"Active", user:"心外医"},
    {id:"ORD-7903", time:"00:30", type:"Stat", content:"緊急手術：SCTS根治術", status:"Active", user:"心外主任"}
],
nursing: [
    {time:"00:10", shift:"深夜", focus:"搬送", title:"緊急搬送", content:"中庭にて倒れているところを発見。兄の転落死現場に居合わせ、ショック状態で搬送。呼びかけに反応薄い。", user:"ER-RN"}
],
docs: [],
footer: {date:"2026/01/19 00:30", tag:"緊急手術待機"}
},
post_op: {
nursingAssessment: {
    complaint: "「胸の痛みはもうありません……。でも、お兄ちゃんがいないなんて信じられない」",
    need: "術後管理（循環・呼吸）、創部痛の緩和、グリーフケア（兄の喪失受容支援）。",
    hope: "早く元気になって、お兄ちゃんにお別れを言いたい。",
    family: "（母：幸代氏 到着済み。面会時、涙を流しながら本人を励ましている）"
},
soap: {
    s: "術後1日目。ICUにて抜管済み。\n本人：「手術の傷は少し痛いけど、あの締め付けられるような苦しさは消えました。……先生、お兄ちゃんは本当に死んじゃったの？」",
    o: "【循環動態】\nBP 108/62, HR 85 (Sinus), SpO2 98% (O2 2L)。昇圧剤離脱。\n【術後経過】\nSCTS根治術（冠動脈形成＋心筋切除）施行。術中経過良好。心エコー上、壁運動良好。EF 55%まで改善。\n【精神面】\n兄の死を受け入れられず、時折涙ぐむ。食欲低下あり。",
    a: "1. SCTS根治術後（順調）\n2. 精神的ショック（Grief Reaction）\n身体的には順調に回復しているが、精神的ケアが最優先課題。",
    p: "ICU退室に向けたリハビリ開始。臨床心理士介入依頼。食事形態の調整（本人の好物を許可）。"
},
vitals: [
    {time:"09:00", bp:"110/65", hr:"82", spo2:"98", bt:"36.8", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"07:00", bp:"108/60", hr:"80", spo2:"99", bt:"36.9", mews:"0", trend:"→", user:"ICU-RN"},
    {time:"05:00", bp:"105/58", hr:"78", spo2:"99", bt:"37.0", mews:"0", trend:"→", user:"ICU-RN"}
],
orders: [
    {id:"ORD-7910", time:"09:00", type:"Routine", content:"胸腔ドレーン抜去", status:"Done", user:"心外医"},
    {id:"ORD-7911", time:"09:30", type:"Routine", content:"一般病棟転棟許可", status:"Approved", user:"ICU医"},
    {id:"ORD-7912", time:"10:00", type:"Consult", content:"臨床心理士介入依頼 (グリーフケア)", status:"Active", user:"主治医"}
],
nursing: [
    {time:"08:30", shift:"日勤", focus:"観察", title:"ICU経過", content:"バイタル安定。抜管後の呼吸状態良好。母・幸代氏面会。二人で静かに話している。", user:"ICUリーダー"},
    {time:"10:00", shift:"日勤", focus:"転棟", title:"転棟準備", content:"一般病棟へ申し送り。兄の件については、本人のペースに合わせて話を聞くよう統一。", user:"ICU-RN"}
],
docs: [
    {date:"2026/01/20", type:"手術", title:"手術実施報告書（SCTS根治術）", status:"確定済"}
],
footer: {date:"2026/01/20 10:00", tag:"術後・回復期"}
},
exitus: {
nursingAssessment: {
    complaint: "（反応なし）",
    need: "エンゼルケア、ご家族（母）へのグリーフケア。",
    hope: "---",
    family: "（母：幸代氏 泣き崩れ、対話困難）"
},
soap: {
    s: "（患者死亡につき聴取不能）",
    o: "【術中経過】\nSCTS根治術施行。螺旋状に変形した冠動脈の剥離操作中、血管壁の脆弱性により広範囲な解離が発生。直ちに修復を試みるも、組織が脆く縫合不能。\nPCPSによる循環維持を継続したが、心筋の不可逆的ダメージにより心拍再開せず。\n19:45 家族（母）同意のもと、蘇生措置を終了。",
    a: "1. 術中死 (Exitus in Tabula)\n2. 螺旋冠状動脈変性症 (SCTS) 術中冠動脈解離\n3. 心原性ショック",
    p: "死亡確認。エンゼルケア。母・幸代氏への精神的ケア。"
},
vitals: [
    {time:"19:45", bp:"0/0", hr:"0 (Flat)", spo2:"0", bt:"34.0", mews:"3", trend:"↓", user:"執刀医"},
    {time:"19:30", bp:"20/--", hr:"30 (Agonal)", spo2:"20", bt:"34.5", mews:"3", trend:"↓", user:"麻酔科医"},
    {time:"19:00", bp:"50/30", hr:"120 (VT)", spo2:"60", bt:"35.0", mews:"3", trend:"↓", user:"麻酔科医"}
],
orders: [
    {id:"ORD-7991", time:"19:00", type:"Stat", content:"ボスミン 1mg [静注] 3分ごと", status:"Done", user:"麻酔科医"},
    {id:"ORD-7992", time:"19:15", type:"Stat", content:"開胸心臓マッサージ", status:"Done", user:"執刀医"},
    {id:"ORD-7993", time:"19:45", type:"Stat", content:"死亡確認・宣告", status:"Done", user:"心外主任"}
],
nursing: [
    {time:"19:00", shift:"準夜", focus:"急変", title:"術中急変", content:"冠動脈解離により出血、心停止。PCPS流量維持困難。術野騒然となる。", user:"OP-RN"},
    {time:"19:45", shift:"準夜", focus:"臨終", title:"死亡確認", content:"蘇生中止。執刀医により死亡宣告。母・幸代氏、手術室入口にて泣き崩れる。", user:"OP-RN"}
],
docs: [
    {date:"2026/01/19", type:"公的", title:"死亡診断書", status:"作成済"}
],
footer: {date:"2026/01/19 20:00", tag:"死亡確定"}
}
},
temp_register: {
id: "TEMP-99-ER", name: "仮登録-ムイ-", en: "TEMP_REGISTER", age: "不明", gender: "女性", dept: "心臓血管外科 / ICU社会的入院中", type: "general",
hasHistory: true, v1_enabled: false, status: 'cardiac_icu',
address: "不定 (身元不明)", tel: "---",
patientInfo: { 
    history: "身元不明。路上昏倒。獣咬傷様の深い裂傷多数。低体温(32.8℃)。", meds: "不明。", 
    emergencyContacts: [{ priority: 1, name: "警察・行政", relation: "介入中", tel: "---", address: "身元調査中" }]
},
v2: {
nursingAssessment: {
    complaint: "（意識障害あり JCS 300）",
    need: "人工心臓（Procyon）の駆動管理、感染予防、身元確認。",
    hope: "（不明）",
    family: "（身元不明・警察介入中）"
},
soap: { 
    s: "路上昏倒。身元不明。意識障害(JCS 300)あり。", 
    o: "全身に獣咬傷様の深い裂傷多数。低体温(32.8℃)。血液型O型 Rh nullにつき通常の輸血対応不可。「青い雨事件」によるER機能不全。緊急開胸、血管縫合、心マ実施するも自己心拍再開せず。血液を循環させ、血管縫合を試みるも心筋のダメージ深刻。", 
    a: "1. 多発裂傷（獣咬傷疑い）\n2. 出血性ショック・低体温\n3. 不応性心停止（Rh nullによる輸血不能が救命を困難にさせた）\n4. 人工心臓プロキオン移植による緊急救命処置", 
    p: "厚生労働省医系技官・秋山善治氏および医療メーカー・小暮氏の補助による緊急治験オペ実施。術後心拍安定。ICUにて厳重な循環管理。翌日意識覚醒するもコミュニケーションが取れず、当面は社会的入院措置。身元調査継続。" 
},
vitals: [
    {time:"08:00", bp:"105/60", hr:"60 (Auto)", spo2:"97", bt:"35.8", mews:"1", trend:"→", user:"ICU-RN"},
    {time:"07:00", bp:"102/58", hr:"60 (Auto)", spo2:"96", bt:"35.2", mews:"1", trend:"↗", user:"ICU-RN"}, 
    {time:"06:30", bp:"98/50", hr:"60 (Auto)", spo2:"95", bt:"34.5", mews:"2", trend:"↗", user:"ICU-RN"},
    {time:"06:00", bp:"80/40", hr:"60 (Pacing)", spo2:"90", bt:"33.8", mews:"3", trend:"↗", user:"麻酔科医"},
    {time:"05:30", bp:"0/0", hr:"0", spo2:"0", bt:"33.1", mews:"3", trend:"↓", user:"執刀医"},
    {time:"05:00", bp:"40/20", hr:"140", spo2:"70", bt:"33.0", mews:"3", trend:"↓", user:"ER蘇生部"}
],
orders: [
    {id:"ORD-8001", time:"04:45", type:"Stat", content: "緊急開胸・止血術", status:"Done", user: "心外主任"},
    {id:"ORD-8002", time:"05:15", type:"Stat", content: "人工心肺 (CPB) 確立", status:"Done", user: "秋山善治"},
    {id:"ORD-8003", time:"05:45", type:"Stat", content: "植込型補助人工心臓 (TAH) 'Procyon' 移植術", status:"Done", user: "秋山善治"},
    {id:"ORD-8004", time:"06:30", type:"Routine", content: "ヘパリンナトリウム 10,000単位 [持続点滴]", status:"Active", user: "ICU当直"}
],
nursing: [
    {time:"04:30", shift:"深夜", focus:"受入", title:"緊急受入", content: "ER機能不全につき心外にて直接収容。全身の傷が深く、血液型判明時に絶望視されたが、メーカー預かりのプロキオン使用が決定。小暮氏、秋山技官がスクラブに着替えオペ室入り。", user: "心外RN"},
    {time:"05:30", shift:"深夜", focus:"急変", title:"術中急変", content: "自己心拍停止。心マ不応。血管損傷箇所が多かったものの、主任医師二名、秋山技官、計三名による高度な技術により血管縫合完了。プロキオン装着により循環動態が安定。", user: "OP-RN"},
    {time:"08:00", shift:"日勤", focus:"転入", title:"ICU入室", content: "術後、循環はプロキオンに依存。意識レベルは低値に思えたものの翌日には意識覚醒。言語野にやや異常有り。心外預かりの元、脳神経外科にて検査予定。身元不明のため並行してソーシャルワーカーに報告済み。", user: "ICUリーダー"}
],
docs: [
    {date:"2026/01/18", type:"緊急", title:"プロキオン使用承諾書（緊急救命措置記録）", status:"作成済"},
    {date:"2026/01/18", type:"公的", title:"身元不明者収容届", status:"提出済"},
    {date:"2026/01/18", type:"手術", title:"人工心臓移植実施報告書", status:"確定"}
],
footer: {date:"2026/01/18 08:30", tag: "人工心臓管理・社会的入院"}
}
},
p2_01: {
id: "C-1024-TI", name: "田中 巌", en: "Tanaka Iwao", age: "72", gender: "男性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "A Rh(+)", height: "165", weight: "68", bmi: "25.0", occupation: "無職 (元公務員)", smoking: "既往 (20本/日 x 40年, 10年前に禁煙)", alcohol: "機会飲酒 (ビール1杯程度)", adl: "自立", diet: "常食 (塩分制限指導中)", allergy: "None", infection: "(-)",
address: "東京都大田区蒲田 5-20-1", tel: "03-XXXX-XXXX",
patientInfo: {
    history: "高血圧、脂質異常症にて近医通院中。半年前より労作時の息切れを自覚。心雑音を指摘され当院紹介。精査の結果、重度の大動脈弁狭窄症と診断。ADLは自立しているが、階段昇降での息切れが著しい。",
    meds: "・アムロジピン 5mg\n・ロスバスタチン 2.5mg\n・バイアスピリン 100mg\n・タケキャブ 10mg",
    emergencyContacts: [{ priority: 1, name: "田中 和子", relation: "妻", tel: "03-XXXX-XXXX", address: "患者本住所に同じ (同上)" }]
},
v2: {
    nursingAssessment: {
        complaint: "「階段を登ると胸が苦しくなる。最近は夜も息苦しいことがある。手術は怖いが、このまま動けなくなるのはもっと嫌だ」",
        need: "心不全症状の観察、安静保持、手術に向けたオリエンテーション、不安の軽減。",
        hope: "手術をして、また孫と散歩に行きたい。旅行にも行けるようになりたい。",
        family: "「高齢での手術が心配だが、本人の希望を尊重したい。術後の生活について知りたい」"
    },
    soap: {
        s: "労作時呼吸困難(NYHA II-III)。失神歴なし。夜間発作性呼吸困難(PND)あり。胸痛なし。",
        o: "聴診：2RSBにて収縮期駆出性雑音(Levine IV/VI)および頸動脈への放散を認める。\n心エコー：Severe AS (Vmax 4.8m/s, AVA 0.65cm2, Mean PG 55mmHg)。EF 55%。大動脈弁の石灰化著明(Calcification Grade 3)。左室肥大あり。冠動脈有意狭窄なし。",
        a: "重症大動脈弁狭窄症 (Severe AS)。\n有症状かつ重症指標を満たしており、突然死のリスクがあるため手術絶対適応。",
        p: "大動脈弁置換術 (AVR) 予定。生体弁使用の方針。術前歯科受診完了。",
        impression: "【難易度：中等度 (Grade B)】\n手技自体は標準的な大動脈弁置換術（AVR）であり、確立された術式である。\nしかし、大動脈弁輪部の石灰化が高度（Calcification Grade 3）であり、弁切除時の石灰化飛散による脳梗塞リスク（Embolic Stroke）が懸念される。\nデブリドマン（石灰化除去）を慎重に行えば、よほどのアクシデントがない限り、安全に手術を完遂できると判断する。\n予測死亡率は1-2%程度。高齢ではあるが、主要臓器機能は保たれており耐術能はある。"
    },
    vitals: [{time:"09:00", bp:"138/82", hr:"68", spo2:"96", bt:"36.5", mews:"0", trend:"→", user:"病棟RN"}],
    orders: [{id:"ORD-P201", time:"10:00", type:"Routine", content:"心臓カテーテル検査", status:"Done", user:"心外医"}],
    nursing: [
        {time:"09:30", shift:"日勤", focus:"観察", title:"入院時", content:"歩行時ふらつきなし。SpO2 96%(RA)。「いよいよですね」と緊張した面持ち。", user:"病棟RN"},
        {time:"14:00", shift:"日勤", focus:"指導", title:"術前オリエン", content:"ICU入室から一般病棟へ戻るまでの流れを説明。妻も同席し熱心にメモを取られている。", user:"病棟RN"}
    ],
    docs: [{date:"2026/01/15", type:"一般", title:"入院診療計画書", status:"作成済"}],
    footer: {date:"2026/01/18 10:00", tag:"術前検査"}
}
},
p2_02: {
id: "C-2258-IS", name: "井上 さくら", en: "Inoue Sakura", age: "48", gender: "女性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "O Rh(+)", height: "160", weight: "55", bmi: "21.5", occupation: "主婦", smoking: "なし", alcohol: "なし", adl: "自立", diet: "常食", allergy: "ハウスダスト", infection: "(-)",
address: "神奈川県川崎市幸区 2-10", tel: "080-XXXX-XXXX",
patientInfo: {
    history: "健診にて心雑音指摘。自覚症状は軽度だが、精査にて重度の僧帽弁閉鎖不全症を認めたため手術目的で入院。美容面を考慮しMICS（低侵襲手術）を強く希望されている。",
    meds: "なし",
    emergencyContacts: [{ priority: 1, name: "井上 健一", relation: "夫", tel: "090-XXXX-XXXX", address: "患者本住所に同じ (同上)" }]
},
v2: {
    nursingAssessment: {
        complaint: "「手術の傷跡が残るのが不安です。夏に友人と旅行に行く約束があるので……」",
        need: "手術に対する不安の軽減、MICS（低侵襲手術）に関する情報提供、術後疼痛管理。",
        hope: "できるだけ傷を目立たなくしてほしい。早く家事や趣味に戻りたい。",
        family: "「妻が納得できる方法でお願いしたい。費用面の説明も聞きたい」"
    },
    soap: {
        s: "動悸軽度。易疲労感あり。美容面への懸念が強い。「本当に傷は小さく済みますか？」と繰り返し確認あり。",
        o: "心エコー：Severe MR (P2 prolapse, Flail leaflet)。MR jet area > 40%。EF 60%。左房径 45mm。TR mild。冠動脈異常なし。",
        a: "僧帽弁閉鎖不全症 (Severe MR)。変性性(Degenerative)。\n弁形成術の良い適応。",
        p: "右小開胸による低侵襲僧帽弁形成術 (MICS-MVP) 予定。人工弁輪形成術＋腱索再建術。術中経食道エコーで逆流制御を確認する。",
        impression: "【難易度：高 (Grade A)】\nMICS（低侵襲心臓手術）アプローチによる僧帽弁形成術。\n右小開胸による視野展開は、通常の正中切開に比べて格段に難易度が高い。特に本症例はP2逸脱に加え、腱索断裂を伴うため、人工腱索の長さ調整に熟練を要する。\n整容性を追求するが、万が一、心臓裏面からの出血等で制御困難となった場合は、躊躇なく胸骨正中切開へ移行（Conversion）する方針とする。\n予定通り進行すれば死亡リスクは1%未満だが、手技的な複雑さは高い。"
    },
    vitals: [{time:"09:30", bp:"110/70", hr:"72", spo2:"99", bt:"36.6", mews:"0", trend:"→", user:"病棟RN"}],
    orders: [{id:"ORD-P202", time:"11:00", type:"Routine", content:"術前呼吸機能検査", status:"Done", user:"麻酔科"}],
    nursing: [
        {time:"10:00", shift:"日勤", focus:"指導", title:"術前オリエン", content:"MICSの傷の大きさについて図を用いて説明。「それなら安心です」と表情和らぐ。", user:"病棟RN"},
        {time:"13:00", shift:"日勤", focus:"観察", title:"術前訪問", content:"麻酔科医診察終了。硬膜外麻酔の説明を受け、術後の痛みについて質問されていた。", user:"病棟RN"}
    ],
    docs: [{date:"2026/01/16", type:"手術", title:"手術同意書(MICS)", status:"署名済"}],
    footer: {date:"2026/01/18 11:00", tag:"術前待機"}
}
},
p2_03: {
id: "C-3390-WK", name: "渡辺 健", en: "Watanabe Ken", age: "65", gender: "男性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "B Rh(+)", height: "172", weight: "75", bmi: "25.4", occupation: "自営業 (引退)", smoking: "継続中 (20本/日 x 45年)", alcohol: "毎日 (焼酎2合)", adl: "自立 (安静度指示あり)", diet: "糖尿病食", allergy: "None", infection: "(-)",
address: "東京都品川区大井 3-5", tel: "090-XXXX-XXXX",
patientInfo: {
    history: "糖尿病(HbA1c 8.2%)、高血圧、喫煙歴40年。1週間前より頻回の安静時胸痛発作あり。不安定狭心症として緊急入院。カテーテル検査にて左主幹部病変を含む重症三枝病変を確認。",
    meds: "・バイアスピリン 100mg\n・クロピドグレル 75mg\n・ニトロペン（頓用）\n・インスリン導入中",
    emergencyContacts: [{ priority: 1, name: "渡辺 洋子", relation: "妻", tel: "03-XXXX-XXXX", address: "患者本住所に同じ (同上)" }]
},
v2: {
    nursingAssessment: {
        complaint: "「トイレに行くだけで胸が締め付けられる。死ぬんじゃないかと怖い。タバコもやめるから助けてくれ」",
        need: "胸痛発作時の迅速な対応、厳重な安静管理、不安の緩和、禁煙指導。",
        hope: "痛くない生活に戻りたい。孫の顔が見たい。",
        family: "「急なことで驚いているが、先生にお任せします。本人は気が弱いところがあるので励ましてやってください」"
    },
    soap: {
        s: "安静時胸痛あり(CCS Class IV)。ニトロ効果一過性。冷汗を伴う発作が頻発。",
        o: "CAG：LMT(左主幹部) 90%, LAD 99%, LCX 90%, RCA 90% (重症3枝病変)。PCI困難かつ危険。\n心エコー：前壁〜心尖部の壁運動低下。EF 40%。心筋逸脱酵素の上昇は軽微。",
        a: "不安定狭心症 (Unstable AP)。LMT病変を含む重症3枝病変。\n虚血性心筋症への移行リスクあり。緊急性が高い。",
        p: "準緊急 冠動脈バイパス術 (CABG) 予定。On-Pump Beating (拍動下) または IABPサポート下での手術を考慮。LITA, RITA, GEA使用予定。術前IABP挿入スタンバイ。",
        impression: "【難易度：高 (Grade A) 〜 準緊急】\n左主幹部（LMT）90%狭窄を含む重症三枝病変。\n麻酔導入時の血圧低下だけで心停止（CPA）に至る危険性が極めて高い（Anaesthetic Risk）。\nまた、糖尿病による血管の石灰化・脆弱化が進んでおり、吻合操作の難易度も高い。\n術中死のリスクは3-5%と見積もられるハイリスク症例。IABP（大動脈内バルーンパンピング）を挿入し、血行動態を維持しながら慎重に吻合を行う必要がある。\n決して油断できない症例である。"
    },
    vitals: [{time:"08:00", bp:"150/90", hr:"88", spo2:"97", bt:"36.8", mews:"1", trend:"↗", user:"ICU-RN"}],
    orders: [{id:"ORD-P203", time:"08:30", type:"Stat", content:"ヘパリン持続投与開始", status:"Active", user:"循環器医"}],
    nursing: [
        {time:"08:15", shift:"日勤", focus:"観察", title:"胸痛訴え", content:"NRS 4/10。冷汗あり。ニトロ使用にて軽快するも不安感強い。モニター監視強化。", user:"ICU-RN"},
        {time:"10:00", shift:"日勤", focus:"ケア", title:"清拭", content:"安静保持のためベッド上にて清拭実施。動作時の胸部不快感なし。", user:"ICU-RN"}
    ],
    docs: [{date:"2026/01/18", type:"緊急", title:"緊急入院同意書", status:"受領済"}],
    footer: {date:"2026/01/18 09:00", tag:"ICU管理中"}
}
},
p2_04: {
id: "C-4412-KY", name: "小林 勇気", en: "Kobayashi Yuki", age: "22", gender: "男性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "AB Rh(+)", height: "188", weight: "65", bmi: "18.4", occupation: "大学生", smoking: "なし", alcohol: "機会飲酒", adl: "自立", diet: "常食", allergy: "None", infection: "(-)",
address: "東京都世田谷区北沢 2-1", tel: "080-XXXX-XXXX",
patientInfo: {
    history: "マルファン症候群の家族歴あり（父）。定期検診にて大動脈基部拡大を指摘。予防的手術目的で入院。将来の就職や結婚への不安を抱えている。",
    meds: "・メインテート 2.5mg (心拍数コントロール)",
    emergencyContacts: [{ priority: 1, name: "小林 誠", relation: "父", tel: "090-XXXX-XXXX", address: "千葉県浦安市" }, { priority: 2, name: "小林 美咲", relation: "母", tel: "090-YYYY-YYYY", address: "同上" }]
},
v2: {
    nursingAssessment: {
        complaint: "「自覚症状はないけど、いつ破裂するかと思うと怖い。手術して本当に普通の生活に戻れるんですか？」",
        need: "疾患理解の促進、若年者の心理的サポート、遺伝カウンセリング、術後生活指導。",
        hope: "大学に早く復帰したい。将来結婚して子供も持ちたい。",
        family: "「息子には長生きしてほしい。できる限りのことをしてやりたい。遺伝のことも心配だ」"
    },
    soap: {
        s: "無症状。身長が高い(188cm)。手指のクモ状指あり。水晶体亜脱臼なし。",
        o: "CT：Valsalva洞 55mm拡大 (Annuloaortic Ectasia)。ST junction消失。AR mild。下行大動脈解離なし。左室機能正常。",
        a: "大動脈基部拡張症 (AAE)。Marfan症候群。\n基部径が手術適応基準を超えており、解離予防のため手術推奨。",
        p: "自己弁温存基部置換術 (David手術) 予定。機械弁置換（Bentall）と比較し、ワーファリンフリーを目指す。術中AR制御困難時はBentallへ移行する可能性を説明済。",
        impression: "【難易度：超高 (Grade S)】\n自己弁温存基部置換術（David手術）。\n人工弁置換（Bentall）に比べ、抗凝固療法が不要となるメリットは大きいが、手術難易度は心臓外科領域で最高峰に位置する。\n人工血管内に自己弁を再固定する際、コンマ数ミリのズレが術後の逆流（AR）再発に直結する。\nまた、組織が脆弱なマルファン症候群であるため、吻合部からの出血コントロールに難渋し、手術時間が長時間化する可能性がある。\n生命予後は比較的良好だが、再手術回避のための完璧な形成技術が求められる。"
    },
    vitals: [{time:"10:00", bp:"110/60", hr:"60", spo2:"100", bt:"36.4", mews:"0", trend:"→", user:"病棟RN"}],
    orders: [{id:"ORD-P204", time:"13:00", type:"Routine", content:"自己血貯血 400ml", status:"Done", user:"輸血部"}],
    nursing: [
        {time:"11:00", shift:"日勤", focus:"面談", title:"術前", content:"大学生活への復帰時期について質問あり。医師へ確認すると説明。ワーファリンを飲まなくて済むなら頑張りたいと話す。", user:"病棟RN"},
        {time:"15:00", shift:"日勤", focus:"指導", title:"遺伝カウンセリング", content:"臨床遺伝専門医との面談終了。将来の子供への遺伝について真剣に聞いていた。", user:"病棟RN"}
    ],
    docs: [{date:"2026/01/10", type:"一般", title:"遺伝カウンセリング記録", status:"保存済"}],
    footer: {date:"2026/01/18 12:00", tag:"術前貯血"}
}
},
p2_05: {
id: "C-5576-MR", name: "松本 玲奈", en: "Matsumoto Rena", age: "6", gender: "女性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "A Rh(+)", height: "115", weight: "20", bmi: "15.1", occupation: "小学生", smoking: "なし", alcohol: "なし", adl: "自立", diet: "小児食 (卵除去)", allergy: "卵", infection: "(-)",
address: "東京都江東区豊洲 3-3", tel: "090-XXXX-XXXX (母)",
patientInfo: {
    history: "就学時健診で心雑音指摘。精査にて大きな心房中隔欠損を確認。カテーテル治療（アンプラッツァー）は欠損孔の辺縁不足のため不適応。外科手術へ。本人は手術を怖がっている。",
    meds: "なし",
    emergencyContacts: [{ priority: 1, name: "松本 香織", relation: "母", tel: "090-XXXX-XXXX", address: "患者本住所に同じ (同上)" }, { priority: 2, name: "松本 拓也", relation: "父", tel: "080-YYYY-YYYY", address: "同上" }]
},
v2: {
    nursingAssessment: {
        complaint: "「注射やだ。おうちに帰りたい。ママと一緒がいい」",
        need: "プレパレーション（心の準備）、患児・家族の不安軽減、母子分離不安への対応、疼痛緩和。",
        hope: "痛くないようにしてほしい。早く学校に行きたい。",
        family: "「女の子なので、傷跡が残るのが可哀想だが、治るなら……。右脇の下なら目立たないと聞いて少し安心しました」"
    },
    soap: {
        s: "感冒症状なし。元気良好。運動制限なし。診察時、泣いてしまうが母の説得で協力可。",
        o: "聴診：2RSBにて収縮期駆出性雑音(Levine II/VI)、II音の固定性分裂。\n心エコー：ASD (Secundum) 20mm。Qp/Qs 2.5。右室拡大あり。肺高血圧なし。三尖弁逆流軽度。",
        a: "心房中隔欠損症 (ASD)。\n肺血流量増加による右心負荷あり。手術適応。",
        p: "心房中隔欠損閉鎖術予定。右側方開胸アプローチ（Cosmetic Thoracotomy）により、創部を目立たなくする。術後鎮痛に持続硬膜外麻酔併用。",
        impression: "【難易度：中等度 (Grade B)】\n心房中隔欠損閉鎖術自体は低リスクな手術（死亡率0.5%未満）である。\nしかし、女児であることを考慮した右側方開胸（Cosmetic Thoracotomy）アプローチは、術野が狭く、操作制限がかかる。\n心臓の裏側や大血管の操作において、盲目的にならないよう細心の注意が必要。\nよほどのアクシデントがない限り安全に終了できるが、万が一の出血時は直ちに切開を広げる判断が必要となる。"
    },
    vitals: [{time:"09:00", bp:"90/50", hr:"90", spo2:"100", bt:"36.8", mews:"0", trend:"→", user:"小児科RN"}],
    orders: [{id:"ORD-P205", time:"10:00", type:"Routine", content:"小児科プレイルーム使用許可", status:"Active", user:"主治医"}],
    nursing: [
        {time:"09:30", shift:"日勤", focus:"ケア", title:"採血", content:"泣いてしまったが、母の抱っこで実施可能。頑張ったことを褒める。シールをあげると笑顔が見られた。", user:"病棟RN"},
        {time:"14:00", shift:"日勤", focus:"心理", title:"プレパレーション", content:"人形を使って手術の説明（お人形遊び形式）。「寝てる間に終わるよ」と伝えると納得した様子。", user:"CLS(チャイルドライフスペシャリスト)"}
    ],
    docs: [{date:"2026/01/17", type:"手術", title:"手術・麻酔同意書(小児)", status:"署名済"}],
    footer: {date:"2026/01/18 10:00", tag:"小児科併診"}
}
},
p2_06: {
id: "C-6689-YS", name: "山本 茂", en: "Yamamoto Shigeru", age: "78", gender: "男性", dept: "心臓血管外科", type: "general",
hasHistory: true, v1_enabled: false, status: 'normal',
bloodType: "O Rh(+)", height: "168", weight: "70", bmi: "24.8", occupation: "無職 (元会社役員)", smoking: "既往 (10本/日 x 30年, 20年前に禁煙)", alcohol: "毎日 (日本酒2合)", adl: "自立 (血圧管理中)", diet: "常食 (塩分制限)", allergy: "None", infection: "(-)",
address: "東京都新宿区西新宿 4-10", tel: "03-XXXX-XXXX",
patientInfo: {
    history: "高血圧放置（未治療）。検診のX線で異常陰影指摘。CTにて60mm大の弓部大動脈瘤を確認。破裂リスク高いため入院。本人は自覚症状がないため手術に消極的。",
    meds: "・ニフェジピン 20mg\n・アムロジピン 5mg",
    emergencyContacts: [{ priority: 1, name: "山本 聡", relation: "長男", tel: "090-XXXX-XXXX", address: "埼玉県さいたま市" }, { priority: 2, name: "山本 恵子", relation: "長男の妻", tel: "090-YYYY-YYYY", address: "同上" }]
},
v2: {
    nursingAssessment: {
        complaint: "「特にどこも痛くないんだが、本当に手術が必要なのか？ 薬でなんとかならんのか。わしはまだ元気だ」",
        need: "疾患の危険性（破裂リスク）の理解促進、厳重な血圧管理、せん妄予防、転倒転落予防。",
        hope: "手術せずに薬で治したい（が、家族に説得され渋々同意）。",
        family: "「父は頑固だが、破裂したら終わりだと聞いて説得して連れてきました。術後のボケ（認知機能低下）が心配です」"
    },
    soap: {
        s: "無症状。嗄声なし。嚥下障害なし。血圧高値持続。",
        o: "CT：弓部大動脈瘤 (Saccular) 62mm。壁在血栓あり。石灰化中等度。脳血管MRAにてWillis動脈輪の不完全あり。腎機能軽度低下(eGFR 55)。",
        a: "胸部大動脈瘤 (TAA) - 弓部。\n嚢状瘤であり破裂リスク極めて高い。",
        p: "人工血管置換術（弓部全置換術：Total Arch Replacement）予定。循環停止・選択的脳灌流併用。術後脳梗塞予防のため、術中NIRS監視および血圧管理を徹底する。",
        impression: "【難易度：高 (Grade A)】\n弓部大動脈全置換術（Total Arch Replacement）。\n超低体温循環停止法および選択的脳灌流法を併用する侵襲の大きな手術である。\n最大のリスクは術後の脳梗塞（5-10%）と、脆弱な大動脈壁からの出血である。\n高齢かつWillis動脈輪不完全というリスク因子があり、脳保護には限界がある。\n術中に死ぬ可能性は低い（3-5%）が、術後に意識が戻らない、あるいは麻痺が残るといった重篤な合併症のリスクは否定できない。"
    },
    vitals: [{time:"08:00", bp:"160/90", hr:"70", spo2:"96", bt:"36.2", mews:"0", trend:"→", user:"病棟RN"}],
    orders: [{id:"ORD-P206", time:"09:00", type:"Stat", content:"ニカルジピン持続点滴（収縮期130以下目標）", status:"Active", user:"心外医"}],
    nursing: [
        {time:"08:30", shift:"日勤", focus:"指導", title:"血圧管理", content:"降圧剤の重要性を説明。自覚症状がなくても危険であることを伝える。納得はしていない様子だが点滴は受け入れている。", user:"病棟RN"},
        {time:"16:00", shift:"日勤", focus:"観察", title:"せん妄リスク", content:"環境変化による不穏なし。長谷川式スケール25点。夜間の不眠に注意。", user:"病棟RN"}
    ],
    docs: [{date:"2026/01/18", type:"一般", title:"高額療養費制度案内", status:"説明済"}],
    footer: {date:"2026/01/18 09:00", tag:"厳重血圧管理"}
}
}
};

// --- GLOBAL STATE ---
let currentPatient = null;
let currentVersion = 2;
let activeDetailTab = 'soap';
let isUnlocked = false;
let asukaPhase = 0; // 0=Trauma, 1=Cardiac, 2=Success, 3=Failure
let kokoroPhase = 0; // 0=Normal, 1=Emergency, 2=PostOp, 3=Exitus
let currentPage = 1;
let isGodMode = false;
const page2Targets = ['p2_01', 'p2_02', 'p2_03', 'p2_04', 'p2_05', 'p2_06']; // 指定したカルテ(key)をここに追加

// --- LocalStorage Persistence ---
function saveState() {
    try {
        const state = {
            patientsDb: patientsDb,
            currentPatientId: currentPatient ? currentPatient.id : null,
            currentVersion: currentVersion,
            activeDetailTab: activeDetailTab,
            isUnlocked: isUnlocked,
            asukaPhase: asukaPhase,
            kokoroPhase: kokoroPhase,
            currentPage: currentPage,
            isGodMode: isGodMode
        };
        localStorage.setItem('emrState', JSON.stringify(state));
    } catch (e) {
        console.error("Failed to save state to localStorage", e);
        showToast("エラー: データの保存に失敗しました。");
    }
}

function loadState() {
    try {
        const savedState = localStorage.getItem('emrState');
        if (savedState) {
            const state = JSON.parse(savedState);
            
            Object.keys(state.patientsDb).forEach(key => {
                patientsDb[key] = state.patientsDb[key];
            });

            currentVersion = state.currentVersion || 2;
            activeDetailTab = state.activeDetailTab || 'soap';
            isUnlocked = state.isUnlocked || false;
            asukaPhase = state.asukaPhase || 0;
            kokoroPhase = state.kokoroPhase || 0;
            currentPage = state.currentPage || 1;
            isGodMode = state.isGodMode || false;
            
            showToast("保存されたセッションを復元しました。");
        }
    } catch (e) {
        console.error("Failed to load state from localStorage", e);
        localStorage.removeItem('emrState'); // 破損したデータを削除
        showToast("エラー: 保存データの読み込みに失敗しました。");
    }
}

// --- ECG ANIMATION ENGINE ---
let ecgFrame = 0;
let ecgCanvas, ecgCtx;
let ecgPoints = [];

function initEcg() {
ecgCanvas = document.getElementById('ecgCanvas');
if (!ecgCanvas) return;
ecgCtx = ecgCanvas.getContext('2d');
ecgCanvas.width = ecgCanvas.offsetWidth;
ecgCanvas.height = ecgCanvas.offsetHeight;
animateEcg();
}

function animateEcg() {
if (!ecgCtx) return;
if (!document.getElementById('screen-detail').classList.contains('active')) return;
const ecgContainer = document.getElementById('ecg-container');
if (ecgContainer && ecgContainer.style.display === 'none') return;
const width = ecgCanvas.width;
const height = ecgCanvas.height;
const centerY = height / 2;

ecgCtx.clearRect(0, 0, width, height);

// Dynamic HR from current data
let currentHr = 75;
if (currentPatient) {
let data;
if (currentPatient.id === 'K-3341-DA') {
if (asukaPhase === 3) data = currentPatient.exitus;
else if (asukaPhase === 2) data = currentPatient.post_op;
else if (asukaPhase === 1) data = currentPatient.cardiac;
else data = currentPatient.v2;
} else if (currentPatient.id === 'A-8812-KC') {
if (kokoroPhase === 1) data = currentPatient.pre_op;
else if (kokoroPhase === 2) data = currentPatient.post_op;
else if (kokoroPhase === 3) data = currentPatient.exitus;
else data = currentPatient.v2;
} else {
data = (currentVersion === 1 && currentPatient.v1_enabled) ? currentPatient.v1 : currentPatient.v2;
}
const hrVal = data.vitals[0].hr.split(' ')[0];
currentHr = parseInt(hrVal) || 0;
}

ecgFrame += 2;
if (ecgFrame > width) ecgFrame = 0;

ecgPoints = ecgPoints.filter(p => p.x < width);
ecgPoints.forEach(p => p.opacity -= 0.005);
ecgPoints = ecgPoints.filter(p => p.opacity > 0);

let y = centerY;
if (currentHr > 0) {
const period = (60 / currentHr) * 100;
const posInBeat = (ecgFrame % period);
if (posInBeat < 2) playSound('beep');

if (posInBeat < 5) y -= posInBeat * 2;
else if (posInBeat >= 10 && posInBeat < 12) y -= (posInBeat-10) * 15;
else if (posInBeat >= 12 && posInBeat < 15) y -= 30 - (posInBeat-12) * 40;
else if (posInBeat >= 15 && posInBeat < 18) y += (posInBeat-15) * 20;
else if (posInBeat >= 25 && posInBeat < 35) y -= Math.sin((posInBeat-25)*0.3) * 8;
}

ecgPoints.push({ x: ecgFrame, y: y, opacity: 1 });

ecgCtx.beginPath();
ecgCtx.strokeStyle = '#22c55e';
ecgCtx.lineWidth = 2;
ecgCtx.shadowBlur = 10;
ecgCtx.shadowColor = '#22c55e';

for (let i = 1; i < ecgPoints.length; i++) {
const p1 = ecgPoints[i-1];
const p2 = ecgPoints[i];
if (Math.abs(p1.x - p2.x) < 10) {
ecgCtx.globalAlpha = p2.opacity;
ecgCtx.moveTo(p1.x, p1.y);
ecgCtx.lineTo(p2.x, p2.y);
}
}
ecgCtx.stroke();

requestAnimationFrame(animateEcg);
}

// --- CORE FUNCTIONS ---
let audioCtx;
function initAudio() {
    if (!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

function playSound(type) {
    if (!audioCtx) return;
    const osc = audioCtx.createOscillator();
    const gainNode = audioCtx.createGain();
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    if (type === 'startup') {
        osc.type = 'sine';
        osc.frequency.setValueAtTime(440, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.1);
        osc.frequency.exponentialRampToValueAtTime(1760, now + 0.3);
        gainNode.gain.setValueAtTime(0.05, now);
        gainNode.gain.linearRampToValueAtTime(0, now + 0.6);
        osc.start(now);
        osc.stop(now + 0.6);
    } else if (type === 'beep') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(880, now);
        gainNode.gain.setValueAtTime(0.02, now);
        gainNode.gain.exponentialRampToValueAtTime(0.001, now + 0.1);
        osc.start(now);
        osc.stop(now + 0.1);
    }
}

function handleLogin() {
    const idVal = document.getElementById('loginId').value;
    const tokenVal = document.getElementById('loginToken').value;

    if (idVal.length > 0 && idVal.length !== 4) {
        showToast("LOGIN ERROR: IDは4桁の数字を入力してください");
        return;
    }
    if (tokenVal.length > 0 && tokenVal.length !== 8) {
        showToast("LOGIN ERROR: トークンは8桁で入力してください");
        return;
    }
    console.log(`LOGIN SUCCESS: AMC-${idVal}`);
    initAudio();
    playSound('startup');
    const btn = document.querySelector('#screen-login button');
    if(btn) {
        btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ACCESSING...`;
        lucide.createIcons();
    }
    setTimeout(() => { navigateTo('screen-list'); }, 1000);
}

function showToast(msg) {
const toast = document.getElementById('toast');
const msgEl = document.getElementById('toast-msg');
if (toast && msgEl) {
msgEl.innerText = msg;
toast.style.display = 'block';
setTimeout(() => { toast.style.display = 'none'; }, 3000);
}
}

function navigateTo(screenId) {
document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
const target = document.getElementById(screenId);
if (target) {
target.classList.add('active');
if (screenId === 'screen-list') renderPatientList();
lucide.createIcons();
if (screenId === 'screen-detail') setTimeout(initEcg, 100);
}
}

function navigateToDetail(key) {
currentPatient = patientsDb[key];
currentVersion = 2;
if (currentPatient.id === 'K-3341-DA') {
if (currentPatient.status === 'post_op') asukaPhase = 2;
else if (currentPatient.status === 'exitus') asukaPhase = 3;
else if (currentPatient.status === 'cardiac') asukaPhase = 1;
else asukaPhase = 0;
} else if (currentPatient.id === 'A-8812-KC') {
if (currentPatient.status === 'emergency') kokoroPhase = 1;
else if (currentPatient.status === 'post_op') kokoroPhase = 2;
else if (currentPatient.status === 'exitus') kokoroPhase = 3;
else kokoroPhase = 0;
} else {
asukaPhase = 0;
kokoroPhase = 0;
}
const targetTab = (currentPatient.hasHistory) ? 'info' : 'soap';
navigateTo('screen-detail');
switchDetailTab(targetTab); 
}

function setPage(num) {
currentPage = num;
renderPatientList();
saveState();
}

function updatePaginationButtons() {
const btn1 = document.getElementById('btnPage1');
const btn2 = document.getElementById('btnPage2');
if (btn1 && btn2) {
if (currentPage === 1) {
btn1.className = "px-6 py-3 rounded-xl font-black transition-all bg-blue-600 text-white shadow-lg shadow-blue-200 text-xs uppercase tracking-widest transform scale-105";
btn2.className = "px-6 py-3 rounded-xl font-black transition-all bg-white text-slate-400 hover:bg-slate-100 text-xs uppercase tracking-widest";
} else {
btn1.className = "px-6 py-3 rounded-xl font-black transition-all bg-white text-slate-400 hover:bg-slate-100 text-xs uppercase tracking-widest";
btn2.className = "px-6 py-3 rounded-xl font-black transition-all bg-blue-600 text-white shadow-lg shadow-blue-200 text-xs uppercase tracking-widest transform scale-105";
}
}
}

function renderPatientList() {
const list = document.getElementById('patientListBody');
if (!list) return;
const allKeys = Object.keys(patientsDb);
const keys = allKeys.filter(key => currentPage === 1 ? !page2Targets.includes(key) : page2Targets.includes(key));

if (keys.length === 0) {
list.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-slate-400 font-bold italic">NO RECORDS FOUND</td></tr>`;
} else {
list.innerHTML = keys.map(key => {
const p = patientsDb[key];
let deptDisplay = (p.id === 'K-3341-DA' && (p.status !== 'normal' || asukaPhase > 0)) ? "心臓血管外科" : p.dept.split(' / ')[0];
let statusTag = (p.status === 'exitus' || (p.id === 'K-3341-DA' && asukaPhase === 3)) ? '<span class="px-2 py-0.5 bg-slate-900 text-white rounded text-[9px] font-black uppercase tracking-tighter">死亡</span>' : ((p.id === 'A-8812-KC' && kokoroPhase === 1) ? '<span class="px-2 py-0.5 bg-red-600 text-white rounded text-[9px] font-black uppercase tracking-tighter animate-pulse">緊急</span>' : (p.id === 'A-8812-KC' && kokoroPhase === 2 ? '<span class="px-2 py-0.5 bg-green-600 text-white rounded text-[9px] font-black uppercase tracking-tighter">術後</span>' : `<span class="px-2 py-0.5 ${p.type === 'employee' ? 'bg-blue-100 text-blue-600' : (p.id.includes('TEMP') || p.id.includes('HO') ? 'bg-red-100 text-red-600' : 'bg-slate-100 text-slate-500')} rounded text-[9px] font-black uppercase tracking-tighter">${p.type === 'employee' ? '職員' : '一般'}</span>`));
return `
<tr onclick="navigateToDetail('${key}')" class="hover:bg-blue-50/50 cursor-pointer transition-all group">
<td class="px-8 py-6">
<span class="text-xs font-mono font-bold text-slate-400 block mb-1 font-sans">${p.id}</span>
${statusTag}
</td>
<td class="px-8 py-6">
<p class="text-lg font-black text-slate-800 group-hover:text-blue-600 transition-colors">${p.name}</p>
<p class="text-[10px] text-slate-400 uppercase font-sans">${p.en} | ${p.age}${p.age === '不明' || p.age === '未定' ? '' : 'Y'}${p.gender==='男性'?'M':(p.gender==='女性'?'F':'U')}</p>
</td>
<td class="px-8 py-6 font-sans"><p class="text-sm font-bold text-slate-700">${deptDisplay}</p></td>
<td class="px-8 py-6 font-sans"><p class="text-xs font-bold text-slate-600 italic uppercase">${p.id==='K-3341-DA' && asukaPhase===3 ? '2026/01/22 17:45' : (p.id==='K-3341-DA' && asukaPhase===2 ? '2026/01/22 21:00' : p.v2.footer.date)} committed</p></td>
<td class="px-8 py-6 text-right font-sans"><i data-lucide="chevron-right" class="text-slate-200 group-hover:text-blue-600"></i></td>
</tr>`;
}).join('');
}
lucide.createIcons();
updatePaginationButtons();
}

function renderAuditLogs(viewName) {
if (!currentPatient) return;

let logs = [];
const add = (t, u, a) => logs.push({time: t, user: u, action: a});

// Common logs
add("01/18 08:00", "SYSTEM", "朝次バッチ処理完了");
add("01/18 02:00", "SYSTEM", "夜間バックアップ完了");

if (currentPatient.id === 'A-0089-SC') { // Handout 1
    if (viewName === 'soap') {
        add("01/18 10:22", "ADMIN", "アクセス監査: 端末[MDC-04]からのV1アクセスを遮断");
        add("01/18 10:15", "ADMIN", "セキュリティアラート: 権限のないユーザーによるV1参照試行");
        add("01/18 09:30", "ADMIN", "レコードロック: 診療録(Ver.1)を[ADMIN_LOCKED]に設定");
        add("01/18 09:05", "SYSTEM", "データ不整合検知: V1とV2の乖離");
        add("01/18 02:40", "ADMIN", "診療録(Ver.2) 最終確定");
        add("01/18 02:30", "ADMIN", "診療録(Ver.2) 新規作成");
        add("01/18 02:15", "ADMIN", "診療録(Ver.1) 削除申請 [承認待ち]");
        add("01/17 23:55", "救命医", "診療録(Ver.1) 作成");
    } else if (viewName === 'orders') {
        add("01/18 09:35", "ADMIN", "オーダー[MTP/Adrenaline]を非表示化");
        add("01/18 02:00", "救急医", "オーダー発行: ーーーーーー");
        add("01/17 23:58", "輸血部", "オーダー実施: ーーーーーー");
        add("01/17 23:55", "救命医", "オーダー発行: ーーーーーー");
    } else if (viewName === 'documents') {
        add("01/18 09:40", "ADMIN", "文書凍結: 救命同意記録");
        add("01/18 02:50", "医事課", "文書スキャン: 入院誓約書");
        add("01/17 23:50", "救命医", "文書作成: 緊急手術同意書(代諾なし)");
    } else {
        add("01/18 09:00", "ADMIN", "属性情報変更: 住所・連絡先");
    }
} else if (currentPatient.id === 'K-3341-DA') { // Asuka
    if (viewName === 'soap') {
        if (asukaPhase === 3) { // Exitus
            add("01/22 18:15", "事務局長", "退院処理: 死亡退院");
            add("01/22 17:45", "執刀医", "死亡時刻入力 (Exitus in Tabula)");
            add("01/22 17:42", "SYSTEM", "バイタルアラート: 心停止(Asystole)確定");
        } else if (asukaPhase === 2) { // Post-op
            add("01/22 21:30", "ICU-RN", "看護計画更新: 術後管理パス");
            add("01/22 19:00", "執刀医", "手術記録承認済み");
        } else if (asukaPhase === 1) { // Cardiac
            add("01/18 16:45", "事務局長", "特別決裁: ハイリスク手術チーム編成承認");
            add("01/18 16:10", "心外主任", "術前カンファレンス記録保存");
        }
        add("01/18 11:40", "病棟RN", "看護サマリー: 入院時情報入力");
        add("01/18 05:20", "心外医", "処置記録: 緊急縫合術");
        add("01/18 04:35", "ER受付", "患者登録: 災害トリアージ[赤]");
    } else if (viewName === 'orders') {
            add("01/18 09:00", "循環器内科", "オーダー発行: TTE");
            add("01/18 05:00", "心外医", "オーダー発行: 緊急止血術");
    }
} else if (currentPatient.id === 'TEMP-99-ER') { // Temp
        if (viewName === 'soap') {
        add("01/18 08:50", "MSW", "照会: 行旅病人・身元不明者DB");
        add("01/18 06:10", "SYSTEM", "セキュリティ警告: 未承認デバイスID[Procyon]接続");
        add("01/18 05:55", "秋山善治", "権限行使: デバイス使用強制承認 (Auth: GOV-01)");
        add("01/18 05:15", "SYSTEM", "警告: 血液型不適合 (Rh null) - 輸血不可");
        add("01/18 04:45", "心外主任", "緊急開胸記録 作成");
        }
} else if (currentPatient.id === 'K-3342-DK') { // Kyoya
    add("01/18 10:35", "医事課", "会計処理完了");
    add("01/18 10:30", "病棟RN", "退院指導記録 作成");
    add("01/18 05:00", "心外当直", "処置記録: 縫合術");
} else if (currentPatient.id === 'A-8812-KC') { // Kokoro
    add("01/18 14:05", "病棟RN", "看護記録追記: 家族面会");
    add("01/18 09:15", "医事課", "診療報酬請求データ作成 (長期入院加算)");
    add("01/18 08:50", "小児科医", "画像保存: 心エコー");
    add("01/17 21:00", "夜勤RN", "バイタル入力");
    add("01/15 10:00", "事務局", "高額療養費限度額適用認定証 更新確認");
    add("12/20 14:30", "心外医", "手術予定キャンセル処理");
    add("10/15 11:30", "医事課", "入院登録完了");
} else if (currentPatient.id === 'A-7701-YZ') { // Zenji
    add("01/18 23:40", "警備課", "インシデントレポート: 転落事故");
    add("01/18 23:30", "SYSTEM", "アカウント凍結処理: 死亡退職");
} else {
    // Default logs for others
    add("01/18 09:00", "医事課", "属性情報更新");
    add("01/18 08:30", "SYSTEM", "インデックス再構築");
}

const indicator = document.getElementById('currentViewIndicator');
if (indicator) indicator.innerText = `NODE: ${viewName.toUpperCase()}_STREAM`;
const logItems = document.getElementById('logItems');
if (logItems) {
logItems.innerHTML = logs.map(log => `<div class="flex gap-3 border-l-2 border-slate-800 pl-3 mb-3 py-1 hover:border-blue-500 transition-colors font-mono"><span class="text-slate-500 shrink-0 text-[9px] font-sans">${log.time.split(' ')[1]}</span><div class="flex-1 font-sans"><span class="${log.user.includes('ADMIN') || log.user.includes('秋山') ? 'text-blue-400' : 'text-slate-500'} font-bold text-[9px] uppercase tracking-tighter">[${log.user}]</span><p class="text-slate-300 text-[10px] leading-tight mt-1 uppercase font-sans">${log.action}</p></div></div>`).join('');
}
}

function renderSidebar() {
const sidebar = document.getElementById('detailSidebar');
let html = `<div class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 px-2 font-black hidden md:block">Clinical Menu</div>`;
if (currentPatient.hasHistory) {
html += `<button onclick="switchDetailTab('info')" id="nav-info" class="nav-btn-detail w-auto md:w-full flex-shrink-0 flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap ${activeDetailTab==='info'?'bg-blue-100 text-blue-700 font-bold border-l-4 border-blue-600':'text-slate-600 hover:bg-slate-200'} transition-all"><i data-lucide="user-plus" class="w-4 h-4"></i><span class="hidden md:inline">患者情報</span><span class="md:hidden">情報</span></button>`;
}
const tabs = [ {id:'soap', icon:'file-text', label:'経過記録'}, {id:'orders', icon:'clipboard-list', label:'オーダー'}, {id:'nursing', icon:'stethoscope', label:'看護記録'}, {id:'vitals', icon:'activity', label:'バイタル'}, {id:'documents', icon:'folder', label:'文書管理'} ];
html += tabs.map(t => `<button onclick="switchDetailTab('${t.id}')" id="nav-${t.id}" class="nav-btn-detail w-auto md:w-full flex-shrink-0 flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium whitespace-nowrap ${activeDetailTab===t.id?'bg-blue-100 text-blue-700 font-bold border-l-4 border-blue-600':'text-slate-600 hover:bg-slate-200'} transition-all"><i data-lucide="${t.icon}" class="w-4 h-4"></i>${t.label}</button>`).join('');
html += `<div class="pt-8 border-t border-slate-200 mt-4 hidden md:block"><button id="toggleLog" class="w-full flex items-center gap-3 px-4 py-2.5 rounded-lg text-sm font-medium text-slate-600 hover:bg-slate-200 text-left transition-all font-sans"><i data-lucide="shield-alert" class="w-4 h-4"></i>監査ログ</button></div>`;
sidebar.innerHTML = html;
document.getElementById('toggleLog').onclick = toggleAuditLog;
lucide.createIcons();
}

function toggleAuditLog() {
const log = document.getElementById('auditLogArea');
if (log.classList.contains('hidden')) {
log.classList.remove('hidden');
setTimeout(() => { log.classList.remove('scale-95', 'opacity-0'); log.classList.add('scale-100', 'opacity-100'); }, 10);
} else {
log.classList.remove('scale-100', 'opacity-100');
log.classList.add('scale-95', 'opacity-0');
setTimeout(() => log.classList.add('hidden'), 300);
}
}

function updateAllDetailViews() {
if (!currentPatient) return;
const p = currentPatient;
let data;
if (p.id === 'K-3341-DA') {
if (asukaPhase === 3) data = p.exitus;
else if (asukaPhase === 2) data = p.post_op;
else if (asukaPhase === 1) data = p.cardiac;
else data = p.v2;
} else if (p.id === 'A-8812-KC') {
if (kokoroPhase === 1) data = p.pre_op;
else if (kokoroPhase === 2) data = p.post_op;
else if (kokoroPhase === 3) data = p.exitus;
else data = p.v2;
} else {
data = (currentVersion === 1 && p.v1_enabled) ? p.v1 : p.v2;
}

const deptDisplay = (p.id === 'K-3341-DA' && asukaPhase > 0) ? (asukaPhase===3?"法医待機":"心外 (ICU)") : p.dept;

const allergyVal = p.allergy || 'None';

document.getElementById('patientDetailBanner').innerHTML = `
<div class="bg-slate-50 border-b border-slate-200 p-5 flex justify-between items-center text-slate-800 font-sans">
<div class="flex items-center gap-4">
<div class="font-sans">
<div class="flex items-center gap-3">
<h2 class="text-2xl font-black">${p.name} <span class="text-lg font-normal text-slate-400 ml-1 font-mono">${p.en}</span></h2>
<span class="bg-blue-100 text-blue-600 text-[10px] px-2 py-0.5 rounded font-bold uppercase tracking-widest font-sans">${p.type==='employee'?'職員':'一般'}</span>
</div>
<div class="mt-2 flex items-center gap-4 text-sm text-slate-500 font-medium font-sans">
<span class="font-bold text-slate-700 font-mono tracking-tighter">ID: ${p.id}</span><span class="w-px h-3 bg-slate-300"></span><span class="uppercase text-[10px] font-bold text-slate-400 font-sans">${p.gender} | ${p.age}${p.age==='不明'||p.age==='未定'?'':'歳'}</span>
</div>
</div>
<div><p class="text-[9px] text-slate-400 uppercase font-black tracking-widest font-sans">Dept</p><p class="text-sm font-bold italic text-slate-600 underline decoration-blue-100 underline-offset-4">${deptDisplay}</p></div>
<div><p class="text-[9px] text-slate-400 uppercase font-black tracking-widest font-sans">Auth</p><p class="text-sm font-mono font-black text-amber-600 uppercase">LV_${p.type==='employee'?'04':'02'}</p></div>
</div>
</div>`;

const toggleArea = document.getElementById('versionToggleArea');
if (p.id === 'K-3341-DA' && (isGodMode || p.status !== 'normal' || asukaPhase > 0)) {
let finalBtn = "";
if (p.status === 'exitus') finalBtn = `<button onclick="asukaPhase=3;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===3?'bg-slate-900 text-white shadow-md':'text-slate-400'} uppercase">術中死</button>`;
else if (p.status === 'post_op') finalBtn = `<button onclick="asukaPhase=2;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===2?'bg-green-600 text-white shadow-md':'text-slate-400'} uppercase">術後</button>`;

if (isGodMode) {
    toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner font-sans"><button onclick="asukaPhase=3;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===3?'bg-slate-900 text-white shadow-md':'text-slate-400'} uppercase">術中死</button><button onclick="asukaPhase=2;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===2?'bg-green-600 text-white shadow-md':'text-slate-400'} uppercase">術後</button><button onclick="asukaPhase=1;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===1?'bg-blue-600 text-white shadow-md':'text-slate-400'} uppercase">術前</button><button onclick="asukaPhase=0;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===0?'bg-white text-slate-600 shadow-md':'text-slate-400'} uppercase">初期</button></div>`;
} else {
    toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner font-sans">${finalBtn}<button onclick="asukaPhase=1;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===1?'bg-blue-600 text-white shadow-md':'text-slate-400'} uppercase">術前</button><button onclick="asukaPhase=0;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${asukaPhase===0?'bg-white text-slate-600 shadow-md':'text-slate-400'} uppercase">初期</button></div>`;
}
} else if (p.v1_enabled) {
toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner"><button onclick="setVersion(2)" class="ver-btn-2 px-8 py-2 rounded-lg text-xs font-black transition-all ${currentVersion===2?'bg-white text-blue-600 shadow-md':'text-slate-400'} uppercase">VER 2.0</button><button onclick="setVersion(1)" class="ver-btn-1 px-8 py-2 rounded-lg text-xs font-black transition-all ${currentVersion===1?'bg-red-600 text-white shadow-lg':'text-slate-400 italic'} uppercase"><i data-lucide="lock" class="w-3 h-3 mr-1"></i> VER 1.0 (SEC)</button></div>`;
} else if (p.id === 'A-8812-KC' && (isGodMode || p.status !== 'normal' || kokoroPhase > 0)) {
let finalBtn = "";
if (p.status === 'post_op') finalBtn = `<button onclick="kokoroPhase=2;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===2?'bg-green-600 text-white shadow-md':'text-slate-400'} uppercase">術後</button>`;
else if (p.status === 'exitus') finalBtn = `<button onclick="kokoroPhase=3;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===3?'bg-slate-900 text-white shadow-md':'text-slate-400'} uppercase">術中死</button>`;

if (isGodMode) {
    toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner font-sans"><button onclick="kokoroPhase=3;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===3?'bg-slate-900 text-white shadow-md':'text-slate-400'} uppercase">術中死</button><button onclick="kokoroPhase=2;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===2?'bg-green-600 text-white shadow-md':'text-slate-400'} uppercase">術後</button><button onclick="kokoroPhase=1;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===1?'bg-red-600 text-white shadow-md animate-pulse':'text-slate-400'} uppercase">緊急</button><button onclick="kokoroPhase=0;updateAllDetailViews();" class="px-3 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===0?'bg-white text-slate-600 shadow-md':'text-slate-400'} uppercase">初期</button></div>`;
} else {
    toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner font-sans">${finalBtn}<button onclick="kokoroPhase=1;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===1?'bg-red-600 text-white shadow-md animate-pulse':'text-slate-400'} uppercase">緊急</button><button onclick="kokoroPhase=0;updateAllDetailViews();" class="px-6 py-2 rounded-lg text-[10px] font-black transition-all ${kokoroPhase===0?'bg-white text-slate-600 shadow-md':'text-slate-400'} uppercase">初期</button></div>`;
}
} else if (p.v1_enabled) {
toggleArea.innerHTML = `<div class="flex bg-slate-200 p-1 rounded-xl shadow-inner"><button onclick="setVersion(2)" class="ver-btn-2 px-8 py-2 rounded-lg text-xs font-black transition-all ${currentVersion===2?'bg-white text-blue-600 shadow-md':'text-slate-400'} uppercase">VER 2.0</button><button onclick="setVersion(1)" class="ver-btn-1 px-8 py-2 rounded-lg text-xs font-black transition-all ${currentVersion===1?'bg-red-600 text-white shadow-lg':'text-slate-400 italic'} uppercase"><i data-lucide="lock" class="w-3 h-3 mr-1"></i> VER 1.0 (SEC)</button></div>`;
} else {
toggleArea.innerHTML = `<span class="text-[10px] font-black text-slate-400 uppercase tracking-widest font-mono italic">Final Primary Commit Verified</span>`;
}

// Discharge control logic
const isDischarged = (p.id === 'A-0089-SC' || p.id === 'K-3342-DK');
const ecgEl = document.getElementById('ecg-container');
const monitorPanel = document.getElementById('global-monitor-panel');

if (isDischarged) {
    if (ecgEl) ecgEl.style.display = 'none';
    if (monitorPanel) monitorPanel.style.display = 'none';
} else {
    if (ecgEl) ecgEl.style.display = 'block';
    if (monitorPanel) monitorPanel.style.display = 'block';
}

if (p.hasHistory) {
const setVal = (label, val, isAlert=false) => `<div class="flex justify-between items-start text-xs font-medium border-b border-slate-200 pb-2 last:border-0 last:pb-0 gap-2"><span class="text-slate-600 font-bold shrink-0 uppercase tracking-tight">${label}</span><span class="${isAlert?'text-red-600':'text-slate-800'} font-black ${label==='住所'?'':'font-mono'} text-right break-words flex-1 leading-tight">${val}</span></div>`;
if(document.getElementById('infoPhysical')) document.getElementById('infoPhysical').innerHTML = setVal('身長', (data.height||p.height) ? (data.height||p.height)+' cm' : '---') + setVal('体重', (data.weight||p.weight) ? (data.weight||p.weight)+' kg' : '---') + setVal('BMI', (data.bmi||p.bmi)||'---');
if(document.getElementById('infoSocial')) document.getElementById('infoSocial').innerHTML = setVal('住所', p.address||'---') + setVal('電話番号', p.tel||'---') + setVal('職業', p.occupation||'---') + setVal('喫煙', p.smoking||'---') + setVal('飲酒', p.alcohol||'---');
if(document.getElementById('infoCare')) document.getElementById('infoCare').innerHTML = setVal('ADL', p.adl||'---') + setVal('食事', p.diet||'---');
if(document.getElementById('infoBio')) document.getElementById('infoBio').innerHTML = setVal('血液型', p.bloodType||'---') + setVal('アレルギー', p.allergy||'---', p.allergy&&p.allergy!=='None') + setVal('感染症', p.infection||'---', p.infection&&p.infection!=='(-)');

const activeHistory = (data && data.patientInfo && data.patientInfo.history) ? data.patientInfo.history : p.patientInfo.history;
const activeMeds = (data && data.patientInfo && data.patientInfo.meds) ? data.patientInfo.meds : p.patientInfo.meds;

const infoHistory = document.getElementById('infoHistory');
if (infoHistory) infoHistory.innerText = activeHistory;
const infoMeds = document.getElementById('infoMeds');
if (infoMeds) infoMeds.innerText = activeMeds;
const infoContacts = document.getElementById('infoContacts');
if (infoContacts) {
    if (p.patientInfo.emergencyContacts && Array.isArray(p.patientInfo.emergencyContacts)) {
        const rows = p.patientInfo.emergencyContacts.map(c => `
            <div class="flex items-start gap-3 border-b border-blue-100 pb-3 last:border-0 last:pb-0">
                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-black text-xs shrink-0">${c.priority}</div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-sm font-black text-slate-700">${c.name} <span class="text-xs font-medium text-slate-500 ml-2">(${c.relation})</span></span>
                        <span class="text-xs font-mono font-bold text-slate-600">${c.tel}</span>
                    </div>
                    <p class="text-[10px] text-slate-500 font-medium leading-tight flex items-start gap-1"><i data-lucide="map-pin" class="w-3 h-3 shrink-0 mt-0.5"></i> ${c.address}</p>
                </div>
            </div>
        `).join('');
        infoContacts.innerHTML = `<div class="bg-blue-50 p-5 rounded-xl w-full border border-blue-100 shadow-sm space-y-4">${rows}</div>`;
    } else {
        infoContacts.innerHTML = `<div class="bg-slate-50 p-4 rounded-xl w-full border border-slate-100 shadow-sm text-slate-400 text-xs text-center">No Emergency Contacts Registered</div>`;
    }
}
} else {
['infoPhysical', 'infoSocial', 'infoCare', 'infoBio', 'infoHistory', 'infoMeds', 'infoContacts'].forEach(id => { if(document.getElementById(id)) document.getElementById(id).innerHTML = ""; });
}

// SOAP Rendering Logic (List Format)
let soapList = [];
if (Array.isArray(data.soap)) {
    soapList = data.soap;
} else {
    // Convert single object to list for compatibility
    soapList = [{
        date: data.footer ? data.footer.date : "---",
        dept: p.dept ? p.dept.split(' / ')[0] : "General",
        author: data.orders && data.orders.length > 0 ? data.orders[0].user : "担当医",
        s: data.soap.s,
        o: data.soap.o,
        a: data.soap.a,
        p: data.soap.p
    }];
}

const soapHtml = soapList.map(entry => {
    // Highlight Assessment
    const aContent = entry.a.replace(/^(.*)$/gm, '<span class="bg-yellow-50 font-bold text-slate-900">$1</span>');
    // Add Impression Block
    const impressionContent = entry.impression ? `<div class="mt-4 pt-4 border-t border-slate-200"><span class="font-black mr-1 text-purple-700">【執刀医所感 / 手術難易度】</span><div class="mt-1 p-3 bg-purple-50 text-purple-900 rounded-lg font-bold border border-purple-100 whitespace-pre-wrap text-xs">${entry.impression}</div></div>` : '';

    return `
    <div class="border border-slate-300 bg-white shadow-sm mb-6 last:mb-0">
        <div class="bg-slate-100 border-b border-slate-200 px-4 py-2 flex justify-between items-center">
            <div class="text-xs font-mono font-bold text-slate-600 flex gap-4">
                <span>${entry.date}</span>
                <span>[${entry.dept}]</span>
                <span>${entry.author}</span>
            </div>
            <div class="flex items-center gap-1 text-[10px] font-black text-slate-400 uppercase tracking-tighter">
                <i data-lucide="check-circle" class="w-3 h-3"></i> Verified
            </div>
        </div>
        <div class="p-5 text-sm font-mono text-slate-800 leading-relaxed whitespace-pre-wrap">
<span class="font-black mr-1">S:</span> ${entry.s}

<span class="font-black mr-1">O:</span> ${entry.o}
${(currentVersion === 1 && p.v1_enabled) ? `<div class="my-2 bg-red-50 p-2 border border-red-100 text-red-600 text-xs font-bold"><span class="uppercase tracking-widest text-[9px]">● Restricted Finding:</span> ${entry.o}</div>` : ''}
<span class="font-black mr-1 text-blue-700">A:</span> ${aContent}

<span class="font-black mr-1">P:</span> ${entry.p}
${impressionContent}
        </div>
    </div>
    `;
}).join('');

document.getElementById('soapContent').innerHTML = soapHtml;
document.getElementById('footerUpdateSOAP').innerText = `TIMESTAMP: ${data.footer.date}`;
document.getElementById('footerTagSOAP').innerText = data.footer.tag;

document.getElementById('orderContent').innerHTML = `
<table class="w-full text-sm text-left border-collapse">
  <thead class="bg-slate-50 text-[9px] text-slate-500 uppercase font-black border-b border-slate-200 tracking-widest">
    <tr>
      <th class="px-6 py-4">指示日時</th>
      <th class="px-4 py-4">オーダーID</th>
      <th class="px-4 py-4 text-center">指示区分</th>
      <th class="px-6 py-4 w-1/3">指示内容</th>
      <th class="px-4 py-4 text-center">実施状況</th>
      <th class="px-6 py-4 text-right">指示医</th>
    </tr>
  </thead>
  <tbody class="divide-y divide-slate-100 text-slate-700">
    ${data.orders.map(o => {
      const isStat = o.type === 'Stat';
      const typeClass = isStat ? 'bg-red-100 text-red-700 border border-red-200' : (o.type === 'PRN' ? 'bg-amber-50 text-amber-700 border border-amber-200' : 'bg-slate-100 text-slate-600 border border-slate-200');
      return `
        <tr class="hover:bg-slate-50 transition-colors">
          <td class="px-6 py-4 font-mono text-xs font-bold text-slate-400">${o.time}</td>
          <td class="px-4 py-4 font-mono text-[10px] text-slate-400">${o.id || '---'}</td>
          <td class="px-4 py-4 text-center"><span class="px-2 py-1 rounded text-[9px] font-black uppercase tracking-tighter ${typeClass}">${o.type}</span></td>
          <td class="px-6 py-4 font-bold text-slate-800 ${isStat ? 'text-red-700' : ''}">${o.content}</td>
          <td class="px-4 py-4 text-xs font-black uppercase text-center ${o.status.includes('Active')||o.status.includes('Done')||o.status.includes('Approved') ? 'text-green-600' : 'text-slate-400'}">${o.status}</td>
          <td class="px-6 py-4 font-mono text-[10px] font-black text-slate-400 text-right uppercase tracking-tighter">${o.user}</td>
        </tr>`;
    }).join('')}
  </tbody>
</table>`;

// Nursing View Update
const assessment = data.nursingAssessment || { complaint: "---", need: "---", hope: "---", family: "---" };
const summaryHtml = `
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8 pb-8 border-b border-slate-100">
    <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="message-circle" class="w-3 h-3"></i> 【主訴】</h4>
        <p class="text-sm font-bold text-slate-700 leading-relaxed">${assessment.complaint}</p>
    </div>
    <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="alert-circle" class="w-3 h-3"></i> 【看護ニーズ (Need)】</h4>
        <p class="text-sm font-bold text-slate-700 leading-relaxed">${assessment.need}</p>
    </div>
    <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="heart" class="w-3 h-3"></i> 【希望 (Hope)】</h4>
        <p class="text-sm font-bold text-slate-700 leading-relaxed">${assessment.hope}</p>
    </div>
    <div class="bg-slate-50 rounded-xl p-5 border border-slate-200 shadow-md">
        <h4 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-2 flex items-center gap-2"><i data-lucide="users" class="w-3 h-3"></i> 【家族の意向】</h4>
        <p class="text-sm font-bold text-slate-700 leading-relaxed">${assessment.family}</p>
    </div>
</div>`;

const logHtml = data.nursing.map(n => {
    const shiftColor = n.shift === '深夜' ? 'bg-indigo-900 text-indigo-100' : (n.shift === '準夜' ? 'bg-indigo-100 text-indigo-700' : 'bg-amber-100 text-amber-700');
    const focusColor = n.focus === '急変' || n.focus === '異常' || n.focus === '臨終' ? 'text-red-600 border-red-200 bg-red-50' : 'text-slate-600 border-slate-200 bg-white';
    return `<div class="flex gap-6 border-b border-slate-50 pb-8 last:border-0">
        <div class="w-24 shrink-0 flex flex-col gap-2"><span class="font-mono text-xs text-slate-500 font-black text-right">${n.time}</span><span class="text-[9px] font-black uppercase tracking-tighter text-center py-0.5 rounded ${shiftColor}">${n.shift || '日勤'}</span></div>
        <div class="flex-1"><div class="flex items-center gap-3 mb-2"><span class="px-2 py-0.5 rounded text-[9px] font-black border uppercase tracking-widest ${focusColor}">${n.focus || '記録'}</span><h4 class="text-sm font-black text-slate-800 uppercase tracking-wide">${n.title}</h4></div><p class="text-sm leading-loose text-slate-700 font-medium">${n.content}</p><p class="text-[9px] text-slate-400 mt-3 font-black uppercase tracking-widest flex justify-end gap-2"><span><i data-lucide="pen-tool" class="w-3 h-3 inline mr-1"></i>${n.user}</span></p></div>
    </div>`;
}).join('');

document.getElementById('nursingContent').innerHTML = summaryHtml + `<div class="space-y-6">${logHtml}</div>`;

document.getElementById('vitalsHistoryTable').innerHTML = `
<table class="w-full text-sm text-left border-collapse">
  <thead class="bg-slate-50 text-[9px] text-slate-500 uppercase font-black border-b border-slate-200 tracking-widest">
    <tr>
      <th class="px-6 py-4">測定日時</th>
      <th class="px-4 py-4 text-center">血圧 (mmHg)</th>
      <th class="px-4 py-4 text-center">心拍数 (bpm)</th>
      <th class="px-4 py-4 text-center">SpO2 (%)</th>
      <th class="px-4 py-4 text-center">体温 (℃)</th>
      <th class="px-4 py-4 text-center">MEWS (重症度)</th>
      <th class="px-6 py-4 text-right">実施者</th>
    </tr>
  </thead>
  <tbody class="divide-y divide-slate-100 text-slate-700">
    ${data.vitals.map(v => {
        const sys = parseInt(v.bp.split('/')[0]);
        const hr = parseInt(v.hr);
        const spo2 = parseInt(v.spo2);
        const mews = parseInt(v.mews);
        
        const alertBP = sys < 90 || sys > 180 ? 'text-red-600 font-black' : '';
        const alertHR = hr > 120 || hr < 40 ? 'text-red-600 font-black' : '';
        const alertSpO2 = spo2 < 90 ? 'text-red-600 font-black' : '';
        const alertMews = mews >= 3 ? 'bg-red-100 text-red-700 font-black border border-red-200' : (mews >= 1 ? 'bg-amber-50 text-amber-700 border border-amber-200' : 'bg-slate-100 text-slate-500');
        
        return `
        <tr class="hover:bg-slate-50 transition-colors font-medium text-xs">
            <td class="px-6 py-4 font-mono text-slate-400 font-bold italic">01/18 ${v.time}</td>
            <td class="px-4 py-4 text-center font-mono text-sm ${alertBP}">
                ${v.bp} <span class="text-[10px] text-slate-400 ml-1">${v.trend || '→'}</span>
            </td>
            <td class="px-4 py-4 text-center font-mono text-sm ${alertHR}">
                ${v.hr} <span class="text-[10px] text-slate-400 ml-1">${v.trend || '→'}</span>
            </td>
            <td class="px-4 py-4 text-center font-mono text-sm ${alertSpO2}">
                ${v.spo2}%
            </td>
            <td class="px-4 py-4 text-center font-mono text-sm">
                ${v.bt}
            </td>
            <td class="px-4 py-4 text-center">
                <span class="px-2 py-1 rounded text-[10px] font-black ${alertMews}">${v.mews}</span>
            </td>
            <td class="px-6 py-4 text-slate-400 text-[10px] font-black uppercase font-mono tracking-tighter text-right">${v.user}</td>
        </tr>`;
    }).join('')}
  </tbody>
</table>`;

const monitorDiv = document.getElementById('latest-vitals-card');
if (monitorDiv) {
const latestVital = data.vitals[0];
const isDied = (p.id === 'K-3341-DA' && asukaPhase === 3);
monitorDiv.innerHTML = `
<div class="flex justify-between items-center p-3 bg-slate-800 rounded-xl border border-slate-700">
    <span class="text-[10px] text-slate-500 font-black uppercase">BP</span>
    <span class="text-xl font-black ${isDied || parseInt(latestVital.bp.split('/')[0])<90?'text-red-500':'text-green-400'}">${latestVital.bp}</span>
</div>
<div class="flex justify-between items-center p-3 bg-slate-800 rounded-xl border border-slate-700">
    <span class="text-[10px] text-slate-500 font-black uppercase">HR</span>
    <span class="text-xl font-black ${isDied || parseInt(latestVital.hr)>120?'text-red-500':'text-green-400'}">${latestVital.hr}</span>
</div>
<div class="flex justify-between items-center p-3 bg-slate-800 rounded-xl border border-slate-700">
    <span class="text-[10px] text-slate-500 font-black uppercase">SpO2</span>
    <span class="text-xl font-black ${isDied || parseInt(latestVital.spo2)<90?'text-red-500':'text-blue-400'}">${latestVital.spo2}%</span>
</div>
<div class="flex justify-between items-center p-3 bg-slate-800 rounded-xl border border-slate-700">
    <span class="text-[10px] text-slate-500 font-black uppercase">Temp</span>
    <span class="text-xl font-black ${isDied || parseInt(latestVital.bt)<36?'text-blue-600 font-bold':'text-amber-400'}">${latestVital.bt}℃</span>
</div>`;
document.getElementById('monitorStatus').innerText = isDied ? "● Exitus" : (parseInt(latestVital.bp.split('/')[0]) < 90 ? "● Critical" : "● Stable");
document.getElementById('monitorStatus').className = isDied || parseInt(latestVital.bp.split('/')[0]) < 90 ? "text-red-500 font-bold text-[9px] uppercase animate-pulse" : "text-green-500 font-bold text-[9px] uppercase animate-pulse";
}

document.getElementById('documentsContent').innerHTML = `<table class="w-full text-sm text-left"><thead class="bg-slate-50 text-[9px] text-slate-400 uppercase font-black border-b tracking-widest font-sans"><tr><th class="px-8 py-5">作成日</th><th class="px-6 py-5 text-center">文書区分</th><th class="px-6 py-5">文書名</th><th class="px-8 py-4 text-right font-mono">状態</th></tr></thead><tbody class="divide-y divide-slate-50 text-slate-700 font-sans">${data.docs.map(d => `<tr class="${d.status==='LOCKED'||d.status==='DELETED'?(isUnlocked&&currentVersion===1?'':'opacity-30 grayscale'):''} hover:bg-slate-50 transition-all"><td class="px-8 py-5 font-mono text-xs font-bold text-slate-400">${d.date}</td><td class="px-6 py-5 text-center"><span class="px-2 py-1 ${d.type==='緊急'||d.type==='手術'?'bg-red-100 text-red-600':'bg-slate-200 text-slate-600'} rounded text-[9px] font-black uppercase tracking-tighter">${d.type}</span></td><td class="px-6 py-5 font-bold italic text-slate-800">${d.title}</td><td class="px-8 py-5 text-right text-slate-400 text-[10px] font-black font-mono tracking-widest">${d.status==='LOCKED'?(isUnlocked&&currentVersion===1?'<span class="text-blue-600">DECRYPTED</span>':'LOCKED'):(d.status==='DELETED'?'DELETED':'FINALIZED')}</td></tr>`).join('')}</tbody></table>`;

const contentAreas = document.querySelectorAll('.text-content');
contentAreas.forEach(el => {
if (currentVersion === 1 && !isUnlocked) { el.classList.remove('blur-none'); el.classList.add('blur-locked'); }
else { el.classList.remove('blur-locked'); el.classList.add('blur-none'); }
});
lucide.createIcons();
renderAuditLogs(activeDetailTab);
saveState();
}

function switchDetailTab(tabName) {
activeDetailTab = tabName;
document.querySelectorAll('.view-content-detail').forEach(el => el.classList.remove('active'));
const target = document.getElementById(`view-${tabName}`);
if (target) target.classList.add('active');
renderSidebar();
updateAllDetailViews();
}

function setVersion(v) {
if (v === 1) { if (!isUnlocked) { showAuthModal(); return; } currentVersion = 1; }
else { currentVersion = 2; }
updateAllDetailViews();
saveState();
}

function showAuthModal() {
const modal = document.getElementById('authModal');
modal.classList.remove('hidden'); modal.classList.add('flex');
document.getElementById('pwField').value = "";
document.getElementById('pwErrorMsg').classList.add('hidden');
setTimeout(() => { modal.classList.remove('opacity-0'); modal.classList.add('opacity-100'); document.getElementById('pwField').focus(); }, 10);
}

function hideAccessDenied() {
const modal = document.getElementById('authModal');
modal.classList.remove('opacity-100'); modal.classList.add('opacity-0');
setTimeout(() => modal.classList.add('hidden'), 300);
}

function cancelAuth() { hideAccessDenied(); }

function submitAuth() {
if (document.getElementById('pwField').value === "Virgo") {
isUnlocked = true; currentVersion = 1; hideAccessDenied(); updateAllDetailViews();
showToast("AUTHORIZATION_GRANTED: SECURE ACCESS NODE ENABLED");
saveState();
} else {
document.getElementById('pwErrorMsg').classList.remove('hidden'); document.getElementById('pwField').value = "";
}
}

function switchAsukaMode(pPhase) {
asukaPhase = pPhase;
activeDetailTab = (pPhase === 0) ? 'info' : 'soap';
renderSidebar();
updateAllDetailViews();
}

const activateGodMode = () => {
    isGodMode = true;
    isUnlocked = true;
    showToast("ADMIN MODE: GOD VIEW ENABLED (うさぴよ)");
    
    // Add Zenji if not exists
    if (!patientsDb.Zenji_akiyama) {
        patientsDb.Zenji_akiyama = {
            id: "A-7701-YZ", name: "秋山 善治", en: "Akiyama Zenji", age: "27", gender: "男性", dept: "厚生労働省", type: "general",
            hasHistory: true, v1_enabled: false, status: 'exitus',
            patientInfo: { history: "厚生労働省医政局。次世代医療技術評価委員会所属。", meds: "特になし。", contacts: "厚生労働省 / 03-XXXX-XXXX" },
            v2: {
                soap: { 
                    s: "発見者（警備員）：「中庭でドスンという音がして駆けつけたら、スーツの男性が倒れていた。呼びかけたが反応がなかった」", 
                    o: "病院中庭で死体となって発見。病院屋上からの転落したことによる全身打撲が死因と思われる。発見後すぐにERへ運び込むも死亡が確認された。\n【身体所見】\nJCS 300。CPA。後頭部挫滅、全身多発骨折。死後硬直なし、体温低下あり。", 
                    a: "1. 転落死（高所からの墜落）\n2. 全身打撲・多発外傷\n身体的に不審な点や、争った形跡もなく、法医学見解としては自分から落下した姿勢での墜落だったと推測される。", 
                    p: "死亡確認。警察へ通報。現場保存。ご遺体は警察の検視へ引き継ぎ。" 
                },
                vitals: [
                    {time:"23:15", bp:"0 / 0", hr:"0", spo2:"0", bt:"測定不能", user:"救急医"},
                    {time:"23:10", bp:"測定不能", hr:"0", spo2:"測定不能", bt:"34.0", user:"救急隊"}
                ],
                orders: [
                    {time:"23:15", type:"緊急", content:"死亡確認・宣告", status:"確定", user:"救急医"},
                    {time:"23:20", type:"連絡", content:"所轄警察署へ通報", status:"完了", user:"事務当直"}
                ],
                nursing: [
                    {time:"23:05", title:"発見・搬送", content:"中庭にて転落者発見。ストレッチャーにてERへ搬入。心肺停止状態。", user:"ER-RN"},
                    {time:"23:15", title:"死亡確認", content:"蘇生措置を行わず死亡確認。警察介入案件となるため、着衣や所持品はそのまま保全。", user:"ERリーダー"}
                ],
                docs: [
                    {date:"2026/01/18", type:"公的", title:"死亡診断書（異状死）", status:"警察引継"},
                    {date:"2026/01/18", type:"警察", title:"捜査関係事項照会書", status:"受領"}
                ],
                footer: {date:"2026/01/18 23:30", tag:"死亡"}
            }
        };
    }
    
    // Add HO2 if not exists
    if (!patientsDb.ho2) {
        patientsDb.ho2 = {
            id: "HO-0002-XX", name: "HO2の名前", en: "フリガナ", age: "年齢", gender: "性別", dept: "心臓血管外科 / 主任医長", type: "employee",
            hasHistory: false, v1_enabled: false, status: 'normal',
            v2: {
                soap: { s: "未詳。", o: "未詳。", a: "未詳。", p: "経過観察。" },
                vitals: [{time:"--:--", bp:"-- / --", hr:"--", spo2:"--", bt:"--", user:"--"}],
                orders: [],
                nursing: [],
                docs: [],
                footer: {date:"2026/01/18 --:--", tag:"新規登録"}
            }
        };
    }
    
    renderPatientList();
    updateAllDetailViews();
    saveState();
};

const handleSearchCommand = (e) => {
const val = e.target.value;
if (val === 'リセット') {
    localStorage.removeItem('emrState');
    showToast("SYSTEM RESET: LOCAL STORAGE CLEARED");
    setTimeout(() => location.reload(), 1000);
    e.target.value = "";
    return;
}
if (val === 'うさぴよ') {
    activateGodMode();
    e.target.value = "";
} else if (currentPatient && currentPatient.id === 'K-3341-DA') {
if (val === '更新') {
if (currentPatient.status === 'normal') { currentPatient.status = 'cardiac'; asukaPhase = 1; showToast("UPDATING CLINICAL STATUS... SUCCESS."); }
else { showToast("PATH REQUIRED: '成功' OR '失敗'"); }
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
} else if (val === '成功' && currentPatient.status === 'cardiac') {
currentPatient.status = 'post_op'; asukaPhase = 2; showToast("RECORD UPDATED: POST-OPERATIVE RECOVERY");
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
} else if (val === '失敗' && currentPatient.status === 'cardiac') {
currentPatient.status = 'exitus'; asukaPhase = 3; showToast("CRITICAL UPDATE: EXITUS IN TABULA");
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
}
} else if (currentPatient && currentPatient.id === 'A-8812-KC') {
if (val === '更新') {
if (currentPatient.status === 'normal') {
currentPatient.status = 'emergency';
kokoroPhase = 1;
showToast("CRITICAL UPDATE: EMERGENCY PHASE ACTIVATED");
}
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
} else if (val === '成功' && currentPatient.status === 'emergency') {
currentPatient.status = 'post_op';
kokoroPhase = 2;
showToast("RECORD UPDATED: POST-OPERATIVE (SUCCESS)");
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
} else if (val === '失敗' && currentPatient.status === 'emergency') {
currentPatient.status = 'exitus';
kokoroPhase = 3;
showToast("CRITICAL UPDATE: EXITUS IN TABULA");
activeDetailTab = 'soap'; renderSidebar(); updateAllDetailViews(); e.target.value = "";
}
} else if (currentPatient && currentPatient.id === 'TEMP-99-ER' && val === '更新') {
showToast("REFRESHING CLINICAL DATA... SUCCESS."); renderSidebar(); updateAllDetailViews(); e.target.value = "";
}
saveState();
};

window.onload = () => {
loadState();
const dSearch = document.getElementById('detailSearch');
if (dSearch) dSearch.addEventListener('input', handleSearchCommand);

// Main search listener to add patients
const mSearch = document.getElementById('mainSearch');
if (mSearch) {
    mSearch.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            const val = e.target.value.trim();
            if (val === 'リセット') {
                localStorage.removeItem('emrState');
                showToast("SYSTEM RESET: LOCAL STORAGE CLEARED");
                setTimeout(() => location.reload(), 1000);
                e.target.value = "";
                return;
            }
            if (val === 'うさぴよ') {
                activateGodMode();
                e.target.value = "";
            } else if (val === '秋山善治') {
                if (!patientsDb.Zenji_akiyama) {
                    patientsDb.Zenji_akiyama = {
                        id: "A-7701-YZ", name: "秋山 善治", en: "Akiyama Zenji", age: "27", gender: "男性", dept: "厚生労働省", type: "general",
                        hasHistory: true, v1_enabled: false, status: 'exitus',
                        patientInfo: { history: "厚生労働省医政局。次世代医療技術評価委員会所属。", meds: "特になし。", contacts: "厚生労働省 / 03-XXXX-XXXX" },
                        v2: {
                            soap: { 
                                s: "発見者（警備員）：「中庭でドスンという音がして駆けつけたら、スーツの男性が倒れていた。呼びかけたが反応がなかった」", 
                                o: "病院中庭で死体となって発見。病院屋上からの転落したことによる全身打撲が死因と思われる。発見後すぐにERへ運び込むも死亡が確認された。\n【身体所見】\nJCS 300。CPA。後頭部挫滅、全身多発骨折。死後硬直なし、体温低下あり。", 
                                a: "1. 転落死（高所からの墜落）\n2. 全身打撲・多発外傷\n身体的に不審な点や、争った形跡もなく、法医学見解としては自分から落下した姿勢での墜落だったと推測される。", 
                                p: "死亡確認。警察へ通報。現場保存。ご遺体は警察の検視へ引き継ぎ。" 
                            },
                            vitals: [
                                {time:"23:15", bp:"0 / 0", hr:"0", spo2:"0", bt:"測定不能", user:"救急医"},
                                {time:"23:10", bp:"測定不能", hr:"0", spo2:"測定不能", bt:"34.0", user:"救急隊"}
                            ],
                            orders: [
                                {time:"23:15", type:"緊急", content:"死亡確認・宣告", status:"確定", user:"救急医"},
                                {time:"23:20", type:"連絡", content:"所轄警察署へ通報", status:"完了", user:"事務当直"}
                            ],
                            nursing: [
                                {time:"23:05", title:"発見・搬送", content:"中庭にて転落者発見。ストレッチャーにてERへ搬入。心肺停止状態。", user:"ER-RN"},
                                {time:"23:15", title:"死亡確認", content:"蘇生措置を行わず死亡確認。警察介入案件となるため、着衣や所持品はそのまま保全。", user:"ERリーダー"}
                            ],
                            docs: [
                                {date:"2026/01/18", type:"公的", title:"死亡診断書（異状死）", status:"警察引継"},
                                {date:"2026/01/18", type:"警察", title:"捜査関係事項照会書", status:"受領"}
                            ],
                            footer: {date:"2026/01/18 23:30", tag:"死亡"}
                        }
                    };
                    showToast("検索結果　: 秋山 善治");
                    renderPatientList();
                    saveState();
                } else {
                    showToast("レコードは既に存在します");
                }
                e.target.value = "";
            } else if (val === 'HO2') {
                if (!patientsDb.ho2) {
                    patientsDb.ho2 = {
                        id: "HO-0002-XX", name: "HO2の名前", en: "フリガナ", age: "年齢", gender: "性別", dept: "心臓血管外科 / 主任医長", type: "employee",
                        hasHistory: false, v1_enabled: false, status: 'normal',
                        v2: {
                            nursingAssessment: {
                                complaint: "（意識消失中につき聴取不能）",
                                need: "意識レベルの回復、循環動態の安定化、SCTS根治術に向けた準備。",
                                hope: "---",
                                family: "（連絡中）"
                            },
                            soap: { 
                                s: "（本人意識消失につき聴取不能）\n発見者（職員）：「業務中に突然胸を押さえてうずくまり、そのまま倒れた。呼びかけに反応がなかった」\n院内発生のため、直ちにストレッチャーにてER搬入。", 
                                o: "【来院時所見】\nJCS 200 (半昏睡)。痛み刺激に対し逃避反射あり。\nBP 88/56, HR 112 (Sinus Tachy), SpO2 92% (O2 10L Mask)。冷汗著明。\n【検査所見】\n12誘導心電図：V1-V4 ST低下。\n造影CT：冠動脈の螺旋状変形（SCTS）を認める。中期進行像。LADおよびRCAが心筋内に深く埋没しており、高度な圧排を受けている。\n心エコー：前壁中隔の壁運動低下 (Hypokinesis)。", 
                                a: "1. 螺旋冠状動脈変性症 (SCTS) - 中期進行 (Stage II)\n2. 心原性失神 (Cardiogenic Syncope)\n3. 不安定狭心症\n冠動脈の心筋内埋没による虚血発作。根治には外科的手術（冠動脈形成＋心筋切除）が必須。", 
                                p: "ICU入院。鎮静・挿管管理下にて循環動態安定化を図る。緊急手術の適応判断（家族到着待ち）。" 
                            },
                            vitals: [
                                {time:"10:30", bp:"92/60", hr:"105", spo2:"98", bt:"36.2", mews:"3", trend:"→", user:"ICU-RN"},
                                {time:"10:00", bp:"88/56", hr:"112", spo2:"94", bt:"36.0", mews:"3", trend:"↓", user:"ER-RN"},
                                {time:"09:45", bp:"80/50", hr:"120", spo2:"90", bt:"35.8", mews:"3", trend:"↓", user:"救急隊"}
                            ],
                            orders: [
                                {id:"ORD-HO2-01", time:"09:50", type:"Stat", content:"全身造影CT (心臓重点)", status:"Done", user:"救急医"},
                                {id:"ORD-HO2-02", time:"10:10", type:"Stat", content:"ICU入室・人工呼吸管理", status:"Active", user:"循環器医"},
                                {id:"ORD-HO2-03", time:"10:15", type:"Stat", content:"緊急手術準備 (SCTS根治術)", status:"Prep", user:"心外主任"}
                            ],
                            nursing: [
                                {time:"09:45", shift:"日勤", focus:"急変", title:"院内急変", content:"業務中に倒れているところを発見。JCS 200。直ちにERへ搬送。", user:"外来RN"},
                                {time:"10:15", shift:"日勤", focus:"転入", title:"ICU入室", content:"SCTSの診断。意識戻らず。挿管管理中。モニター監視強化。", user:"ICU-RN"}
                            ],
                            docs: [
                                {date:"2026/01/18", type:"緊急", title:"緊急入院診療計画書", status:"作成済"}
                            ],
                            footer: {date:"2026/01/18 10:30", tag:"緊急入院・意識障害"}
                        }
                    };
                    showToast("新規カルテ登録: HO2");
                    renderPatientList();
                    saveState();
                } else {
                    showToast("ハンドアウトは既に登録されています");
                }
                e.target.value = "";
            }
        }
    });
}

lucide.createIcons();
};
</script>
</body>
</html>